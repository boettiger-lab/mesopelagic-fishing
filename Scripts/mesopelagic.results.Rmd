---
title: "mesopelagic.rpath"
output: github_document
---

## CODE information ##
# Originally from Kerim Aydin (kerim.aydin@noaa.gov) from July 10th, 2019
# Modified by Laura Koehn - Fall 2019

```{r}
library(tidyverse)
library(data.table)
library(viridisLite)
```


#Start of Koehn's code
```{r}
#Rpath uses a parameter object created by create.rpath.params to conduct the mass balance of the system
library(Rpath)

Cbase <- "../Data/Groupinfo_CalCur-USE.csv"  # Base biomass, production, fishing, etc.
Cdiet <- "../Data/Diet_CalCur_USE.csv"  # Diet matrix
```


```{r}
# Load unbalanced Ecopath model from csv files 
#Created parameter files outside of R and read in using read.rpath.params function. This merges several different flat files into an R object of the list type. The function create.rpath.params will generate an Rpath.param. This ensures that all of the correct columns are present in the parameter file. 
CalCur_unbal <- read.rpath.params(Cbase, Cdiet)
check.rpath.params(CalCur_unbal)
```

# Running Ecopath in R: balanced an unbalanced Ecopath object
```{r}
#Balance the scenario using rpath function 
Cal_bal <- rpath(CalCur_unbal) 
Cal_bal

#Combine two data frames into a single data frame 
cbind(Cal_bal$Group, Cal_bal$EE)
cbind(Cal_bal$Group, Cal_bal$TL) 

#webplot: way to make a basic food web plot. Can add many different arguments to change preferences. 
webplot(Cal_bal, eco.name = "California Current",
        labels = TRUE)
```

# List of species for plotting
```{r}
#Koehn's defined functional groups 
all_species <- Cal_bal$Group[1:92] 
mammals <- Cal_bal$Group[71:85] 
seabirds <- c(Cal_bal$Group[60:70], Cal_bal$Group[86:92])
pred_fish  <- Cal_bal$Group[33:59] 

#My defined functional groups 
forage <- Cal_bal$Group[19:27]

predators_mesopelagic <- c(Cal_bal$Group[15], Cal_bal$Group[18], Cal_bal$Group[28:29], Cal_bal$Group[33], Cal_bal$Group[37:38], Cal_bal$Group[42:48], Cal_bal$Group[50:56], Cal_bal$Group[58:60], Cal_bal$Group[63], Cal_bal$Group[65:67], Cal_bal$Group[69:70], Cal_bal$Group[72:73], Cal_bal$Group[76:80], Cal_bal$Group[82], Cal_bal$Group[85:88])
predators_mesopelagic

commercial_predators <- c(Cal_bal$Group[18], Cal_bal$Group[33], Cal_bal$Group[37:38], Cal_bal$Group[42:48], Cal_bal$Group[50:56], Cal_bal$Group[58:59])
commercial_predators

noncommerical_predators <- c(Cal_bal$Group[18], Cal_bal$Group[28], Cal_bal$Group[33], Cal_bal$Group[37:38], Cal_bal$Group[43:47], Cal_bal$Group[50:56], Cal_bal$Group[58:60], Cal_bal$Group[63], Cal_bal$Group[65:67], Cal_bal$Group[69:70], Cal_bal$Group[72:73], Cal_bal$Group[76:80], Cal_bal$Group[82], Cal_bal$Group[85:88])
noncommerical_predators

diet_under_0.05 <- c(Cal_bal$Group[15], Cal_bal$Group[18], Cal_bal$Group[28], Cal_bal$Group[37], Cal_bal$Group[43:47], Cal_bal$Group[50], Cal_bal$Group[52:53], Cal_bal$Group[55], Cal_bal$Group[58:59], Cal_bal$Group[60], Cal_bal$Group[65:67], Cal_bal$Group[69],Cal_bal$Group[72:73], Cal_bal$Group[77:80], Cal_bal$Group[82], Cal_bal$Group[86:88])
diet_under_0.05

#Diet proportion of mesopelagic fish equal to or greater than 0.05
diet_over_0.05 <- c(Cal_bal$Group[29], Cal_bal$Group[33], Cal_bal$Group[38], Cal_bal$Group[42], Cal_bal$Group[48], Cal_bal$Group[51], Cal_bal$Group[54], Cal_bal$Group[56], Cal_bal$Group[63], Cal_bal$Group[70], Cal_bal$Group[76], Cal_bal$Group[85])
diet_over_0.05
```

#Base scenario 
```{r}
yearlist = 2000:2020

base_sim_scene <- rsim.scenario(Cal_bal, CalCur_unbal, years = yearlist)
scene0 <- base_sim_scene
run0   <- rsim.run(scene0, method='AB', years=yearlist) 
rsim.plot(run0,all_species)

#Scene0 and scene1 are identical, Koehn just redefined it like this so we will too
scene1 <- base_sim_scene
identical(scene0, scene1)

temp= frate.table(scene0)
temp
```

#MODEL 1: IGNORING BYCATCH 

# Manipulating fishing rates: different scenarios 
```{r}
#Scene1= Rsim.scenario, parameter here = frate (can modify one of three parameters: effort, frate, adn catch), sardine= group, sim.year= yearlist so saying year of simulation that should be modified (or range), sim.month= month of year that should be modified and if set to 0 then all months are modified 
#VALUE: Returns an Rpath.sim object with the new fishing parameter
#Fishing them down by constantly applying fishing rate to their original biomass 

scene_0.8 <- adjust.fishing(scene1, "FRATE", "mesopelagics", yearlist, value= 0.80)
run_0.8 <- rsim.run(scene_0.8, method='AB', years=yearlist)
rsim.plot(run_0.8,all_species) 
run_0.8

scene_0.5 <- adjust.fishing(scene1, "FRATE", "mesopelagics", yearlist, value= 0.50)
run_0.5 <- rsim.run(scene_0.5, method='AB', years=yearlist)
rsim.plot(run_0.5,all_species) 
run_0.5

scene_0.25 <- adjust.fishing(scene1, "FRATE", "mesopelagics", yearlist, value= 0.25)
run_0.25 <- rsim.run(scene_0.25, method='AB', years=yearlist)
rsim.plot(run_0.25,all_species) 
run_0.25

scene_1.0 <- adjust.fishing(scene1, "FRATE", "mesopelagics", yearlist, value= 1)
run_1.0 <- rsim.run(scene_1.0, method='AB', years=yearlist)
rsim.plot(run_1.0,all_species) 
run_1.0

```

# Fish down and recovery scenario, fish for 25 years and stop and look at how popualtion recovers
```{r}
# helper function to look up the ending biomass of a scenario
end_biomass <- function(rsim){return(rsim$out_BB[dim(rsim$out_BB)[1], 2:(dim(rsim$out_BB)[2])])}
end_biomass
#scene2 <- base_sim_scene
#scene2 <- adjust.fishing(scene2, "FRATE", "Anchovy", 2000:2020, value=2.0)
#scene2 <- adjust.fishing(scene2, "FRATE", "Sardine", 2020:2050, value=1.0)
#run2   <- rsim.run(scene2, method='AB', years=yearlist)
#rsim.plot(run2,all_species) 

end_biomass(run2)['mesopelagics']
```

#100% DEPLETION LEVEL
# After the year 2000, run each year separately, setting each year's target
```{r}
target_sp <- "mesopelagics"
target_F <- 1.0
names(target_F) <- target_sp 

library(data.table)
scene3 <- copy(base_sim_scene)
run3 <- rsim.run(scene3, method = 'AB', years=2000)
for (yr in 2001:2020){
  # stock assessment based on current biomass * error
  #for 2 species: assessment <- end_biomass(run3)[target_sp] * (runif(2) + 0.5)  
assessment <- end_biomass(run3)[target_sp] * (runif(length(target_sp)) + 0.5)
assessment

  # convert target F * assessment to a total catch 
  catches <- target_F * assessment
  
  # apply each catch to each species
  for (sp in target_sp){
    scene3 <- adjust.fishing(scene3, "CATCH", sp, yr, value=catches[sp])
  }
  # run 1 year
  run3 <- rsim.step(scene3, run3, method='AB', year.end=yr) 
}  
rsim.plot(run3,all_species)  
```

#Changing data set so we can change plotting
```{r}
rsim.plot.fun <- function(Rsim.output, spname, indplot = F, ...){
  opar <- par(no.readonly = T)
  if(indplot == F){
    biomass <- Rsim.output$out_BB[, 2:ncol(Rsim.output$out_BB)]
    n <- ncol(biomass)
    start.bio <- biomass[1, ]
    start.bio[which(start.bio == 0)] <- 1
    rel.bio <- matrix(NA, dim(biomass)[1], dim(biomass)[2])
    for(isp in 1:n) rel.bio[, isp] <- biomass[, isp] / start.bio[isp]
  }
  rel.bio
} 

names_spp<- run3$params$spname[2:94]

#Need to make z into data frame, before was matrix, names is for data frame not matrix
#Ways to do this in tidy verse but this is quick fix
z_3 <-rsim.plot.fun(run3)
z_3 <-as.data.frame(z_3)
names(z_3) <- names_spp
z_3$month <- 1:252

#This vectors adds in the month
data_3 <- gather(z_3, key = spp, value = biomass, -month)

#Graphs 
library(viridis)
plot3_1 <- data_3 %>% filter(spp == commercial_predators) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") + 
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno") +
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour= "Commercial predators")
plot3_1

plot3_2 <- data_3 %>% filter(spp == noncommerical_predators) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") + 
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno") +
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour = "Noncommercial predators")
plot3_2

plot3_3 <- data_3 %>% filter(spp == predators_mesopelagic) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") + 
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno")+
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour = "Predators of mesopelagic fish")
plot3_3

plot3_4 <- data_3 %>% filter(spp == diet_over_0.05) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") + 
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno")+
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour = "Predators with diet proportion over 0.05")
plot3_4

plot3_5 <- data_3 %>% filter(spp == diet_under_0.05) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") + 
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno")+
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour = "Predators with diet proportion under 0.05")
plot3_5
```

#Change overtime plot for 100% depletion
```{r}
change_3_overtime_df <- function(species) {
  x = seq(0,1, length.out = length(species))
  color = viridis(n = length(species), option= "B")
  par(mar = c(6,12,2,4))
  specieyear3 = run3$annual_BB[1, species]
  specieyearlast = run3$annual_BB[length(yearlist), species]
  value <- (specieyearlast/specieyear3)
  cbind(species, value)
}

#3.1: Commercial

change_3_1_df<- change_3_overtime_df(commercial_predators)
change_3_1_df <- as.data.frame(change_3_1_df)
change_3_1 <- change_3_1_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

change_3_1_plot <- change_3_1 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0.2, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D")+
xlab("Proportion of original biomass") + ylab("Commercial predators") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_3_1_plot

#3.2: Noncommercial

change_3_2_df<- change_3_overtime_df(noncommerical_predators)
change_3_2_df <- as.data.frame(change_3_2_df)
change_3_2 <- change_3_2_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

change_3_2_plot <- change_3_2 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0.2, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D")+
xlab("Proportion of original biomass") + ylab("Noncommercial predators") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_3_2_plot

#3.3: Mesopelagic predators

change_3_3_df<- change_3_overtime_df(predators_mesopelagic)
change_3_3_df <- as.data.frame(change_3_3_df)
change_3_3 <- change_3_3_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

#If use have to add in 0 for mesopelagics 
change_3_3_plot <- change_3_3 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0.2, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D")+
xlab("Proportion of original biomass") + ylab("Predators of mesopelagic fish") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_3_3_plot

#3.4: Diet over 0.05
change_3_4_df<- change_3_overtime_df(diet_over_0.05)
change_3_4_df <- as.data.frame(change_3_4_df)
change_3_4 <- change_3_4_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

change_3_4_plot <- change_3_4 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0.2, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D")+
xlab("Proportion of original biomass") + ylab("Predators with diet proportion over 0.05") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_3_4_plot

#3.5: Diet under 0.05 

change_3_5_df<- change_3_overtime_df(diet_under_0.05)
change_3_5_df <- as.data.frame(change_3_5_df)
change_3_5 <- change_3_5_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

#If use you need to add a value at 0 for mesopelagics! 
change_3_5_plot <- change_3_5 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0.2, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D") +
xlab("Proportion of original biomass") + ylab("Predators with diet proportion under 0.05") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_3_5_plot

```

#80% DEPLETION LEVEL!! 
# After the year 2000, run each year separately, setting each year's target

```{r}
target_sp <- "mesopelagics"
target_F <- 0.80
names(target_F) <- target_sp 

library(data.table)
scene4 <- copy(base_sim_scene)
run4 <- rsim.run(scene4, method = 'AB', years=2000)
for (yr in 2001:2020){
  # stock assessment based on current biomass * error
  # use this if including two species: assessment <- end_biomass(run3)[target_sp] * (runif(2) + 0.5)   
assessment <- end_biomass(run4)[target_sp] * (runif(length(target_sp)) + 0.5)
assessment
  # convert target F * assessment to a total catch 
  catches <- target_F * assessment
  
  # apply each catch to each species
  for (sp in target_sp){
    scene4 <- adjust.fishing(scene4, "CATCH", sp, yr, value=catches[sp])
  }
  # run 1 year
  run4 <- rsim.step(scene4, run4, method='AB', year.end=yr) 
}  
rsim.plot(run4,all_species)  
```

#Changing data set so we can change plotting
```{r}
rsim.plot.fun <- function(Rsim.output, spname, indplot = F, ...){
  opar <- par(no.readonly = T)
  if(indplot == F){
    biomass <- Rsim.output$out_BB[, 2:ncol(Rsim.output$out_BB)]
    n <- ncol(biomass)
    start.bio <- biomass[1, ]
    start.bio[which(start.bio == 0)] <- 1
    rel.bio <- matrix(NA, dim(biomass)[1], dim(biomass)[2])
    for(isp in 1:n) rel.bio[, isp] <- biomass[, isp] / start.bio[isp]
  }
  rel.bio
} 

names_spp<- run4$params$spname[2:94]

#Need to make z into data frame, before was matrix, names is for data frame not matrix
#Ways to do this in tidy verse but this is quick fix
z_4<-rsim.plot.fun(run4)
z_4<-as.data.frame(z_4)
names(z_4) <- names_spp
z_4$month <- 1:252


#This vectors adds in the month
data_4 <- gather(z_4, key = spp, value = biomass, -month )

plot4_1 <- data_4 %>% filter(spp == commercial_predators) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") +  
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno") +
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  labs(colour= "Commercial predators") 
plot4_1

plot4_2 <- data_4 %>% filter(spp == noncommerical_predators) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") + 
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno")+
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour = "Noncommercial predators")
plot4_2

plot4_3 <- data_4 %>% filter(spp == predators_mesopelagic) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") + 
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno")+
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour = "Predators of mesopelagic fish")
plot4_3

plot4_4 <- data_4 %>% filter(spp == diet_over_0.05) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") + 
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno")+
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour = "Predators with diet proportion over 0.05")
plot4_4

plot4_5 <- data_4 %>% filter(spp == diet_under_0.05) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") + 
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno")+
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour = "Predators with deiet proportion under 0.05")
plot4_5
```

#Change overtime plot for 80% depletion
```{r}
change_4_overtime_df <- function(species) {
  x = seq(0,1, length.out = length(species))
  color = viridis(n = length(species), option= "B")
  par(mar = c(6,12,2,4))
  specieyear4 = run4$annual_BB[1, species]
  specieyearlast = run4$annual_BB[length(yearlist), species]
  value <- (specieyearlast/specieyear4)
  cbind(species, value)
}

#3.1: Commercial

change_4_1_df<- change_4_overtime_df(commercial_predators)
change_4_1_df <- as.data.frame(change_4_1_df)
change_4_1 <- change_4_1_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

change_4_1_plot <- change_4_1 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0.2, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D")+
xlab("Proportion of original biomass") + ylab("Commercial predators") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_4_1_plot

#3.2: Noncommercial

change_4_2_df<- change_4_overtime_df(noncommerical_predators)
change_4_2_df <- as.data.frame(change_4_2_df)
change_4_2 <- change_4_2_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

change_4_2_plot <- change_4_2 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0.2, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D")+
xlab("Proportion of original biomass") + ylab("Noncommercial predators") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_4_2_plot

#3.3: Mesopelagic predators

change_4_3_df<- change_4_overtime_df(predators_mesopelagic)
change_4_3_df <- as.data.frame(change_4_3_df)
change_4_3 <- change_4_3_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

#If use have to add in 0 for mesopelagics 
change_4_3_plot <- change_4_3 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D")+
xlab("Proportion of original biomass") + ylab("Predators of mesopelagic fish") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_4_3_plot

#3.4: Diet over 0.05
change_4_4_df<- change_4_overtime_df(diet_over_0.05)
change_4_4_df <- as.data.frame(change_4_4_df)
change_4_4 <- change_4_4_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

change_4_4_plot <- change_4_4 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0.2, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D")+
xlab("Proportion of original biomass") + ylab("Predators with diet proportion over 0.05") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_4_4_plot

#3.5: Diet under 0.05 

change_4_5_df<- change_4_overtime_df(diet_under_0.05)
change_4_5_df <- as.data.frame(change_4_5_df)
change_4_5 <- change_4_5_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

#If use you need to add a value at 0 for mesopelagics! 
change_4_5_plot <- change_4_5 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0.2, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D") +
xlab("Proportion of original biomass") + ylab("Predators with diet proportion under 0.05") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_4_5_plot
```

#DEPLETION LEVEL OF 50%
```{r}
target_sp <- "mesopelagics"
target_F <- 0.50
names(target_F) <- target_sp 

library(data.table)
scene5 <- copy(base_sim_scene)
run5 <- rsim.run(scene5, method = 'AB', years=2000)
for (yr in 2001:2020){
  # stock assessment based on current biomass * error
  # use this if including two species: assessment <- end_biomass(run3)[target_sp] * (runif(2) + 0.5)   
assessment <- end_biomass(run5)[target_sp] * (runif(length(target_sp)) + 0.5)
assessment
  # convert target F * assessment to a total catch 
  catches <- target_F * assessment
  
  # apply each catch to each species
  for (sp in target_sp){
    scene5 <- adjust.fishing(scene5, "CATCH", sp, yr, value=catches[sp])
  }
  # run 1 year
  run5 <- rsim.step(scene5, run5, method='AB', year.end=yr) 
}  
rsim.plot(run5,all_species)  
```

#Changing data set so we can change plotting
```{r}
rsim.plot.fun <- function(Rsim.output, spname, indplot = F, ...){
  opar <- par(no.readonly = T)
  if(indplot == F){
    biomass <- Rsim.output$out_BB[, 2:ncol(Rsim.output$out_BB)]
    n <- ncol(biomass)
    start.bio <- biomass[1, ]
    start.bio[which(start.bio == 0)] <- 1
    rel.bio <- matrix(NA, dim(biomass)[1], dim(biomass)[2])
    for(isp in 1:n) rel.bio[, isp] <- biomass[, isp] / start.bio[isp]
  }
  rel.bio
} 

names_spp<- run5$params$spname[2:94]

#Need to make z into data frame, before was matrix, names is for data frame not matrix
#Ways to do this in tidy verse but this is quick fix
z_5<-rsim.plot.fun(run5)
z_5<-as.data.frame(z_5)
names(z_5) <- names_spp
z_5$month <- 1:252


#This vectors adds in the month
data_5 <- gather(z_5, key = spp, value = biomass, -month )

plot5_1 <- data_5 %>% filter(spp == commercial_predators) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") + 
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno") +
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour= "Commercial predators")
plot5_1

plot5_2 <- data_5 %>% filter(spp == noncommerical_predators) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") + 
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno")+
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour = "Noncommercial predators")
plot5_2

plot5_3 <- data_5 %>% filter(spp == predators_mesopelagic) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") + 
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno")+
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour = "Predators of mesopelagic fish")
plot5_3

plot5_4 <- data_5 %>% filter(spp == diet_over_0.05) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") + 
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno")+
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour = "Predators with diet proportion over 0.05")
plot5_4

plot5_5 <- data_5 %>% filter(spp == diet_under_0.05) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") + 
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno")+
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour = "Predators with diet proportion under 0.05")
plot5_5

```

#Change overtime plot for 50% depletion
```{r}
change_5_overtime_df <- function(species) {
  x = seq(0,1, length.out = length(species))
  color = viridis(n = length(species), option= "B")
  par(mar = c(6,12,2,4))
  specieyear5 = run5$annual_BB[1, species]
  specieyearlast = run5$annual_BB[length(yearlist), species]
  value <- (specieyearlast/specieyear5)
  cbind(species, value)
}

#3.1: Commercial

change_5_1_df<- change_5_overtime_df(commercial_predators)
change_5_1_df <- as.data.frame(change_5_1_df)
change_5_1 <- change_5_1_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

change_5_1_plot <- change_5_1 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0.2, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D")+
xlab("Proportion of original biomass") + ylab("Commercial predators") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_5_1_plot

#3.2: Noncommercial

change_5_2_df<- change_5_overtime_df(noncommerical_predators)
change_5_2_df <- as.data.frame(change_5_2_df)
change_5_2 <- change_5_2_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

change_5_2_plot <- change_5_2 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0.2, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D")+
xlab("Proportion of original biomass") + ylab("Noncommercial predators") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_5_2_plot

#3.3: Mesopelagic predators

change_5_3_df<- change_5_overtime_df(predators_mesopelagic)
change_5_3_df <- as.data.frame(change_5_3_df)
change_5_3 <- change_5_3_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

#If use have to add in 0 for mesopelagics 
change_5_3_plot <- change_5_3 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0.2, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D")+
xlab("Proportion of original biomass") + ylab("Predators of mesopelagic fish") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_5_3_plot

#3.4: Diet over 0.05
change_5_4_df<- change_5_overtime_df(diet_over_0.05)
change_5_4_df <- as.data.frame(change_5_4_df)
change_5_4 <- change_5_4_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

change_5_4_plot <- change_5_4 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0.2, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D")+
xlab("Proportion of original biomass") + ylab("Predators with diet proportion over 0.05") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_5_4_plot

#3.5: Diet under 0.05 

change_5_5_df<- change_5_overtime_df(diet_under_0.05)
change_5_5_df <- as.data.frame(change_5_5_df)
change_5_5 <- change_5_5_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

#If use you need to add a value at 0 for mesopelagics! 
change_5_5_plot <- change_5_5 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0.2, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D") +
xlab("Proportion of original biomass") + ylab("Predators with diet proportion under 0.05") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_5_5_plot
```

#DEPLETION LEVEL OF 25%
```{r}

target_sp <- "mesopelagics"
target_F <- 0.25
names(target_F) <- target_sp 

library(data.table)
scene6 <- copy(base_sim_scene)
run6 <- rsim.run(scene6, method = 'AB', years=2000)
for (yr in 2001:2020){
  # stock assessment based on current biomass * error
  # use this if including two species: assessment <- end_biomass(run3)[target_sp] * (runif(2) + 0.5)   
assessment <- end_biomass(run6)[target_sp] * (runif(length(target_sp)) + 0.5)
assessment
  # convert target F * assessment to a total catch 
  catches <- target_F * assessment
  
  # apply each catch to each species
  for (sp in target_sp){
    scene6 <- adjust.fishing(scene6, "CATCH", sp, yr, value=catches[sp])
  }
  # run 1 year
  run6 <- rsim.step(scene6, run6, method='AB', year.end=yr) 
}  
rsim.plot(run6,all_species)  
```

#Changing data set so we can change plotting
```{r}
rsim.plot.fun <- function(Rsim.output, spname, indplot = F, ...){
  opar <- par(no.readonly = T)
  if(indplot == F){
    biomass <- Rsim.output$out_BB[, 2:ncol(Rsim.output$out_BB)]
    n <- ncol(biomass)
    start.bio <- biomass[1, ]
    start.bio[which(start.bio == 0)] <- 1
    rel.bio <- matrix(NA, dim(biomass)[1], dim(biomass)[2])
    for(isp in 1:n) rel.bio[, isp] <- biomass[, isp] / start.bio[isp]
  }
  rel.bio
} 

names_spp<- run6$params$spname[2:94]

#Need to make z into data frame, before was matrix, names is for data frame not matrix
#Ways to do this in tidy verse but this is quick fix
z_6<-rsim.plot.fun(run6)
z_6<-as.data.frame(z_6)
names(z_6) <- names_spp
z_6$month <- 1:252

data_6 <- gather(z_6, key = spp, value = biomass, -month )

plot6_1 <- data_6 %>% filter(spp == commercial_predators) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") + 
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno") +
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour= "Commercial predators")
plot6_1

plot6_2 <- data_6 %>% filter(spp == noncommerical_predators) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") + 
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno")+
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour = "Noncommercial predators")
plot6_2

plot6_3 <- data_6 %>% filter(spp == predators_mesopelagic) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") + 
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno")+
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour = "Predators of mesopelagic fish")
plot6_3

plot6_4 <- data_6 %>% filter(spp == diet_over_0.05) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") + 
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno")+
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour = "Predators with diet proportion over 0.05")
plot6_4

plot6_5 <- data_6 %>% filter(spp == diet_under_0.05) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Relative biomass") + 
theme_bw() + 
scale_color_viridis(discrete = TRUE, option = "inferno")+
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour = "Predators with diet proportion under 0.05")
plot6_5

```

#Change overtime plot for 25% depletion
```{r}
change_6_overtime_df <- function(species) {
  x = seq(0,1, length.out = length(species))
  color = viridis(n = length(species), option= "B")
  par(mar = c(6,12,2,4))
  specieyear6 = run6$annual_BB[1, species]
  specieyearlast = run6$annual_BB[length(yearlist), species]
  value <- (specieyearlast/specieyear6)
  cbind(species, value)
}

#3.1: Commercial

change_6_1_df<- change_6_overtime_df(commercial_predators)
change_6_1_df <- as.data.frame(change_6_1_df)
change_6_1 <- change_6_1_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

change_6_1_plot <- change_6_1 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0.2, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D")+
xlab("Proportion of original biomass") + ylab("Commercial predators") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_6_1_plot

#3.2: Noncommercial

change_6_2_df<- change_6_overtime_df(noncommerical_predators)
change_6_2_df <- as.data.frame(change_6_2_df)
change_6_2 <- change_6_2_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

change_6_2_plot <- change_6_2 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0.2, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D")+
xlab("Proportion of original biomass") + ylab("Noncommercial predators") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_6_2_plot

#3.3: Mesopelagic predators

change_6_3_df<- change_6_overtime_df(predators_mesopelagic)
change_6_3_df <- as.data.frame(change_6_3_df)
change_6_3 <- change_6_3_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

#If use have to add in 0 for mesopelagics 
change_6_3_plot <- change_6_3 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D")+
xlab("Proportion of original biomass") + ylab("Predators of mesopelagic fish") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_6_3_plot

#3.4: Diet over 0.05
change_6_4_df<- change_6_overtime_df(diet_over_0.05)
change_6_4_df <- as.data.frame(change_6_4_df)
change_6_4 <- change_6_4_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

change_6_4_plot <- change_6_4 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0.2, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D")+
xlab("Proportion of original biomass") + ylab("Predators with diet proportion over 0.05") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_6_4_plot

#3.5: Diet under 0.05 

change_6_5_df<- change_6_overtime_df(diet_under_0.05)
change_6_5_df <- as.data.frame(change_6_5_df)
change_6_5 <- change_6_5_df %>% mutate(value = round(as.numeric(paste(value)), 2)) %>% arrange(value)

#If use you need to add a value at 0 for mesopelagics! 
change_6_5_plot <- change_6_5 %>% ggplot(aes(x= value, y=species)) + geom_point(aes(col= species)) + xlim(0.2, 1.6) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + scale_color_viridis(discrete = TRUE, option = "D") +
xlab("Proportion of original biomass") + ylab("Predators with diet proportion under 0.05") + theme_bw() + theme(panel.border = element_blank()) +
theme(axis.line = element_line(colour = "black")) +
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
theme(plot.title= element_text(hjust=.5)) + 
theme(legend.position= "none")  
change_6_5_plot
```

#DEPLETION LEVEL OF 0% 
```{r}
base_sim_scene <- rsim.scenario(Cal_bal, CalCur_unbal, years = yearlist)
scene0 <- base_sim_scene
run0 <- rsim.run(scene0, method='AB', years=yearlist) 
rsim.plot(run0,all_species)
```



#MODEL #2: INCORPORATING BYCATCH 

#100% fishing, bycatch 20%
```{r}
#Frate.table: creates table of fishing mortalities by species group and gear for an Rpath.sim object 
temp = frate.table(scene0)
temp
#Calculate effort
q <- c(0.5, 1.0, 2.0, 3.0)
q
F <- c(0.20, 0.20, 0.20, 0.20)
F
E <- F/q
E
adjust.fishing(scecne3.2, "Effort", sp, yr, value= effort)
bycatch_sp <- ("euphausiids", "small jellies", "large jellies")
bycatch_effort <- 


target_sp <- "mesopelagics"
target_F <- 1.0
names(target_F) <- target_sp 

library(data.table)
scene3.2 <- copy(base_sim_scene)
run3.2 <- rsim.run(scene3.2, method = 'AB', years=2000)
for (yr in 2001:2020){
  # stock assessment based on current biomass * error
  # use this if including two species: 
  #assessment <- end_biomass(run3.2)[target_sp] * (runif(4) + 0.5)
assessment <- end_biomass(run3.2)[target_sp] *(runif(length(target_sp)) + 0.5)
assessment
  # convert target F * assessment to a total catch 
  catches <- target_F * assessment
  
  # apply each catch to each species
  for (sp in target_sp){
    scene3.2 <- adjust.fishing(scene3.2, "CATCH", sp, yr, value=catches[sp])
  }
  # run 1 year
  run3.2 <- rsim.step(scene3.2, run3.2, method='AB', year.end=yr) 
}  
rsim.plot(run3.2,all_species) 

```

#Change overtime 

```{r}
change_overtime_df <- function(species) {
  x = seq(0,1, length.out = length(species))
  color = viridis(n = length(species), option= "B")
  par(mar = c(6,12,2,4))
  specieyear3.2 = run3.2$annual_BB[1, species]
  specieyearlast = run3.2$annual_BB[length(yearlist), species]
  value <- (specieyearlast/specieyear3.2)
  cbind(species, value)
}

change_overtime_plot(mammals)
change_overtime_plot(pred_fish)
change_overtime_plot(predators_mesopelagic)
change_overtime_plot(commercial_predators)
change_overtime_plot(noncommerical_predators)
change_overtime_plot(forage)
change_overtime_plot(diet_over_0.05)
change_overtime_plot(diet_under_0.05)


```

#20% fishing, bycatch 4%
```{r}
target_sp <- c("mesopelagics", "euphausiids", "small jellies", "large jellies", "carniv-zoops")
target_F <- c(.20, 0.04, 0.04, 0.04, 0.04)
names(target_F) <- target_sp 

library(data.table)
scene6.2 <- copy(base_sim_scene)
run6.2 <- rsim.run(scene6.2, method = 'AB', years=2000)
for (yr in 2001:2020){
  # stock assessment based on current biomass * error
  # use this if including two species: 
  assessment <- end_biomass(run6.2)[target_sp] * (runif(5) + 0.5)   
#assessment <- end_biomass(run5)[target_sp] * (runif(length(target_sp)) + 0.5)
assessment
  # convert target F * assessment to a total catch 
  catches <- target_F * assessment
  
  # apply each catch to each species
  for (sp in target_sp){
    scene6.2 <- adjust.fishing(scene6.2, "CATCH", sp, yr, value=catches[sp])
  }
  # run 1 year
  run6.2 <- rsim.step(scene6.2, run6.2, method='AB', year.end=yr) 
}  
rsim.plot(run6.2,all_species) 

```

#Change overtime 

```{r}
change_overtime_df <- function(species) {
  x = seq(0,1, length.out = length(species))
  color = viridis(n = length(species), option= "B")
  par(mar = c(6,12,2,4))
  specieyear3.2 = run3.2$annual_BB[1, species]
  specieyearlast = run3.2$annual_BB[length(yearlist), species]
  value <- (specieyearlast/specieyear3.2)
  cbind(species, value)
}

change_overtime_plot(mammals)
change_overtime_plot(pred_fish)
change_overtime_plot(predators_mesopelagic)
change_overtime_plot(commercial_predators)
change_overtime_plot(noncommerical_predators)
change_overtime_plot(forage)
change_overtime_plot(diet_over_0.05)
change_overtime_plot(diet_under_0.05)


```



