---
title: "RunEcopath_Rpath"
output: html_document
---

## CODE information ##
# Originally from Kerim Aydin (kerim.aydin@noaa.gov) from July 10th, 2019
# Modified by Laura Koehn - Fall 2019

#Download packages that Rpath uses
```{r}
library(tidyverse)
install.packages("rpath")
library(data.table)
```


#Start of Koehn's code
```{r}
#Rpath uses a parameter object created by create.rpath.params to conduct the mass balance of the system
library(Rpath)

Cbase <- "Groupinfo_CalCur-USE.csv"  # Base biomass, production, fishing, etc.
Cdiet <- "Diet_CalCur_USE.csv"  # Diet matrix
# Groupinfo_CalCur-1.csv is the file from Kerim Aydin
# where solved biomass was copy and pasted. EEs may be very
# slightly off due to rounding errors. Have different types: The types are: living = 0, primary producer = 1, detritus = 2, and fleet = 3. 

# So I ran the Ecopath balance (that gave negative values), then for all the top-down balanced groups
# (where EE but not biomass was specified) I copied the balanced Biomass into the file, 
# then blanked out EEs (so all groups are now being solved for EE).  That solved the negative EE problem - 
#   all those EEs are 0 now. (file attached).

```


```{r}
# Load unbalanced Ecopath model from csv files 
#Created parameter files outside of R and read in using read.rpath.params function. This merges several different flat files into an R object of the list type. The function create.rpath.params will generate an Rpath.param. This ensures that all of the correct columns are present in the parameter file. 
CalCur_unbal <- read.rpath.params(Cbase, Cdiet)
check.rpath.params(CalCur_unbal)

```

# Running Ecopath in R: balanced an unbalanced Ecopath object

```{r}
#Balance the scenario using rpath function 
Cal_bal   <- rpath(CalCur_unbal) 

#Combine two data frames into a single data frame 
cbind(Cal_bal$Group, Cal_bal$EE)
cbind(Cal_bal$Group, Cal_bal$TL) 
# CHECK****!!?!?!?!!? as some values seem weird --> checked for EE and all values match the ones on the original data set published (this also calculates some not listed there), checekd for trophic level with Field et al. (2004) and all seems normal! 

#webplot: way to make a basic food web plot. Can add many different arguments to change preferences. 
webplot(Cal_bal, eco.name = "California Current",
        labels = TRUE)
```

# list of species for plotting
```{r}
#Just listed all the different functional groups
all_species <- Cal_bal$Group[1:92] 
mammals <- Cal_bal$Group[71:85] 
seabirds <- c(Cal_bal$Group[60:70], Cal_bal$Group[86:92])
pred_fish  <- Cal_bal$Group[33:59] 
```

```{r}
#What rsim does: rsim.scenario converts the rpath output to rates appropriate for running the simulation, can adjust base scenario through adjust.scenario, adjust.fishing, and adjust.forcing

yearlist = 2000:2050

# Set up an initial scenario - initializes row labels to match years
#Cal_bal as balanced Rpath model, CalCur_unbal as R object containing Rpath parameters- is generated through read.rpath.params, and years is the vector of each year of simulation (this is simulating year 2,000- 2,050)
base_sim_scene <- rsim.scenario(Cal_bal, CalCur_unbal, years = yearlist)

# Baseline (equilibrium) run, make a copy of the baseline scenario
scene0 <- base_sim_scene

# Rsim.run runs the simulation, Run ecosim once, for indicated years
#AB: is the method of integration, Adams-Bashforth 4 numerical integration, doesn't seem like anything we need to change 
run0   <- rsim.run(scene0, method='AB', years=yearlist) 
rsim.plot(run0,all_species)

run0$annual_CC
```

```{r}
rsim.plot.fun <- function(Rsim.output, spname, indplot = F, ...){
  opar <- par(no.readonly = T)
  if(indplot == F){
    biomass <- Rsim.output$out_BB[, 2:ncol(Rsim.output$out_BB)]
    n <- ncol(biomass)
    start.bio <- biomass[1, ]
    start.bio[which(start.bio == 0)] <- 1
    rel.bio <- matrix(NA, dim(biomass)[1], dim(biomass)[2])
    for(isp in 1:n) rel.bio[, isp] <- biomass[, isp] / start.bio[isp]
  }
  rel.bio
} 

names_spp<- run1$params$spname[2:94]

z<-rsim.plot.fun(run1)

#Need to make z into data frame, before was matrix, names is for data frame not matrix
#Ways to do this in tidy verse but this is quick fix
z<-as.data.frame(z)

names(z) <- names_spp
z$month <- 1:612

data<- gather(z, key = spp, value = biomass, -month )
data %>% filter(spp == c("Sardine","Dungeness", "Albatross", "mesopelagics", "Skates")) %>% ggplot(aes(month,biomass)) + geom_line(aes(colour= factor(spp)))

```



# Simple sardine and anchovy fishing scenario- CONFUSED on as.numeric 
```{r}
scene1 <- base_sim_scene

#Frate.table: creates table of fishing mortalities by species group and gear for an Rpath.sim object 
#I believe that this is data that was already inputed into the Ecopath model 
temp = frate.table(scene1)

sardinebase = as.numeric(temp[5, "Total"])
#anchovybase = as.numeric(temp[6, "Total"])
#marketsquidbase = as.numeric(temp[4, "Total"])
frate.table(scene1)
```

# Change fishing rate for certain species and years- VALUE!!??
```{r}

#Scene1= Rsim.scenario, parameter here = frate (can modify one of three parameters: effort, frate, adn catch), sardine= group, sim.year= yearlist so saying year of simulation that should be modified (or range), sim.month= month of year that should be modified and if set to 0 then all months are modified 
#VALUE: Returns an Rpath.sim object with the new fishing parameter

scene1 <- adjust.fishing(scene1, "FRATE", "Sardine", yearlist, value=sardinebase*3)  
#scene1 <- adjust.fishing(scene1, "FRATE", "Anchovy", yearlist, value=anchovybase*3) 
#scene1 <- adjust.fishing(scene1, "FRATE", "Market squid", yearlist, value=marketsquidbase*2) 

run1 <- rsim.run(scene1, method='AB', years=yearlist)
rsim.plot(run1,all_species) 

scene1 <- adjust.fishing(scene1, "FRATE",  "euphausiids", yearlist, value=3) 
run1   <- rsim.run(scene1, method='AB', years=yearlist)
rsim.plot(run1,all_species) 

```

#What does value mean ?? Don't run this chunk of code 
```{r}
#This example is from the basic Rpath and Rsim
#For example, we can double the effort of the trawler fleet after 25 years using the `adjust.fishing` function! 
REco.sim <- adjust.fishing(REco.sim, 'EFFORT', group = 'Trawlers', sim.year = 25:100, 
                           value = 2)
```


```{r}

library(viridis)
# color = viridis(n = length(seabirds))
# plot(run1$annual_BB[,1], ylab = "Predator Biomass", col = "White", xlab = "Time", ylim = c(0,0.004))
# for(i in 1:length(seabirds)) {
#   lines(run1$annual_BB[,seabirds[i]], col = color[i])
# }
# par(mar = c(4,4,2,6))
# legend("topright",legend = seabirds, lty = 1, col = color,
#        inset=c(-0.35,0),  xpd = TRUE, cex = 0.5)

change_overtime_plot <- function(species) {
  x = seq(0,1, length.out = length(species))
  color = viridis(n = length(species))
  par(mar = c(6,12,2,4))
  specieyear1 = run1$annual_BB[1, species]
  specieyearlast = run1$annual_BB[length(yearlist), species]
  plot(rev(specieyearlast/specieyear1),x, ylab = "", bg = rev(color), col = "Black",
       xlab = "Biomass proportion", ylim = c(0,1), pch = 21,
       xlim = c(0,1.6), axes = F, frame = F)
  
  axis(2, at =x, labels = rev(species), las = 2, pos = 0, cex.axis = 1.5)
  axis(1, at=c(0.2, 0.4, 0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8), cex.axis=1, tck=0.01, pos = -0.05)
  abline(v = 1, lty =3)

}
change_overtime_plot(seabirds)
change_overtime_plot(mammals)
change_overtime_plot(pred_fish)

forage <- Cal_bal$Group[19:27] 
change_overtime_plot(forage)

random = c(Cal_bal$Group[7], Cal_bal$Group[19:22],
           Cal_bal$Group[40:47])
change_overtime_plot(random)

```

# Fish down and recovery scenario
```{r}
# helper function to look up the ending biomass of a scenario
end_biomass <- function(rsim){return(rsim$out_BB[dim(rsim$out_BB)[1], 2:(dim(rsim$out_BB)[2])])}

scene2 <- base_sim_scene
scene2 <- adjust.fishing(scene2, "FRATE", "Anchovy", 2000:2020, value=2.0)
scene2 <- adjust.fishing(scene2, "FRATE", "Sardine", 2020:2050, value=1.0)
run2   <- rsim.run(scene2, method='AB', years=yearlist)
rsim.plot(run2,all_species) 
```


# After the year 2000, run each year separately, setting each year's target
# fishing rates based on inperfect (randomized) assessment.
```{r}
target_sp <- c("Sardine","Anchovy")
target_F <- c(1.0, 0.2)
names(target_F) <- target_sp 

for (yr in 2001:2050){
  # stock assessment based on current biomass * error
  assessment <- end_biomass(run2)[target_sp] * (runif(2) + 0.5)   
  # convert target F * assessment to a total catch 
  catches <- target_F * assessment
  # apply each catch to each species
  for (sp in target_sp){
    scene2 <- adjust.fishing(scene2, "CATCH", sp, yr, value=catches[sp])
  }
  # run 1 year
  run2 <- rsim.step(scene2, run2, method='AB', year.end=yr) 
}  
rsim.plot(run2,all_species)  
```



