---
title: "mesopelagic.rpath"
output: github_document
---

## CODE information ##
# Originally from Kerim Aydin (kerim.aydin@noaa.gov) from July 10th, 2019
# Modified by Laura Koehn - Fall 2019

```{r}
library(tidyverse)
library(data.table)
```

#Start of Koehn's code
```{r}
#Rpath uses a parameter object created by create.rpath.params to conduct the mass balance of the system
library(Rpath)

Cbase <- "Groupinfo_CalCur-USE.csv"  # Base biomass, production, fishing, etc.
Cdiet <- "Diet_CalCur_USE.csv"  # Diet matrix

```


```{r}
# Load unbalanced Ecopath model from csv files 
#Created parameter files outside of R and read in using read.rpath.params function. This merges several different flat files into an R object of the list type. The function create.rpath.params will generate an Rpath.param. This ensures that all of the correct columns are present in the parameter file. 
CalCur_unbal <- read.rpath.params(Cbase, Cdiet)
check.rpath.params(CalCur_unbal)

```

# Running Ecopath in R: balanced an unbalanced Ecopath object

```{r}
#Balance the scenario using rpath function 
Cal_bal   <- rpath(CalCur_unbal) 
Cal_bal

#Combine two data frames into a single data frame 
cbind(Cal_bal$Group, Cal_bal$EE)
cbind(Cal_bal$Group, Cal_bal$TL) 
# CHECK****!!?!?!?!!? as some values seem weird --> checked for EE and all values match the ones on the original data set published (this also calculates some not listed there), checekd for trophic level with Field et al. (2004) and all seems normal! 

#webplot: way to make a basic food web plot. Can add many different arguments to change preferences. 
webplot(Cal_bal, eco.name = "California Current",
        labels = TRUE)
```

# list of species for plotting
```{r}
#Define different functional groups
all_species <- Cal_bal$Group[1:92] 
mammals <- Cal_bal$Group[71:85] 
seabirds <- c(Cal_bal$Group[60:70], Cal_bal$Group[86:92])
pred_fish  <- Cal_bal$Group[33:59] 
forage <- Cal_bal$Group[19:27]
```

```{r}
#What rsim does: rsim.scenario converts the rpath output to rates appropriate for running the simulation, can adjust base scenario through adjust.scenario, adjust.fishing, and adjust.forcing

yearlist = 2000:2050

# Set up an initial scenario - initializes row labels to match years
#Cal_bal as balanced Rpath model, CalCur_unbal as R object containing Rpath parameters- is generated through read.rpath.params, and years is the vector of each year of simulation (this is simulating year 2,000- 2,050)
base_sim_scene <- rsim.scenario(Cal_bal, CalCur_unbal, years = yearlist)

# Baseline (equilibrium) run, make a copy of the baseline scenario
scene0 <- base_sim_scene

# Rsim.run runs the simulation, Run ecosim once, for indicated years
#AB: is the method of integration, Adams-Bashforth 4 numerical integration, doesn't seem like anything we need to change 
run0   <- rsim.run(scene0, method='AB', years=yearlist) 
rsim.plot(run0,all_species)

```


# Change fishing rate for certain species and years: Fishing rate of 75% (25% of biomass remaining)
```{r}
#Scene0 and scene1 are identical, Koehn just redefined it like this so we will too
scene1 <- base_sim_scene
identical(scene0, scene1)

#Scene1= Rsim.scenario, parameter here = frate (can modify one of three parameters: effort, frate, adn catch), sardine= group, sim.year= yearlist so saying year of simulation that should be modified (or range), sim.month= month of year that should be modified and if set to 0 then all months are modified 
#VALUE: Returns an Rpath.sim object with the new fishing parameter

scene2 <- adjust.fishing(scene1, "FRATE", "mesopelagics", yearlist, value= 0.25)
run2 <- rsim.run(scene2, method='AB', years=yearlist)
rsim.plot(run1,all_species) 
run2


```
#Changing data set so we can change plotting
```{r}
rsim.plot.fun <- function(Rsim.output, spname, indplot = F, ...){
  opar <- par(no.readonly = T)
  if(indplot == F){
    biomass <- Rsim.output$out_BB[, 2:ncol(Rsim.output$out_BB)]
    n <- ncol(biomass)
    start.bio <- biomass[1, ]
    start.bio[which(start.bio == 0)] <- 1
    rel.bio <- matrix(NA, dim(biomass)[1], dim(biomass)[2])
    for(isp in 1:n) rel.bio[, isp] <- biomass[, isp] / start.bio[isp]
  }
  rel.bio
} 

names_spp<- run1$params$spname[2:94]


#Need to make z into data frame, before was matrix, names is for data frame not matrix
#Ways to do this in tidy verse but this is quick fix
z<-rsim.plot.fun(run1)
z<-as.data.frame(z)
names(z) <- names_spp
z$month <- 1:612


#This vectors adds in the month
data <- gather(z, key = spp, value = biomass, -month )
data %>% filter(spp == c("Market squid", "Sardine", "Anchovy", "Herring", "Pacific Mackerel", "Sand lance", "Whitebait smelt", "Other smelt", "Saury")) %>% ggplot(aes(x= month, y = biomass)) + geom_line(aes(colour= factor(spp))) + xlab("Month") + ylab("Biomass") + 
theme_bw() + 
theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + labs(colour = "Forage fish")

```

#Change over time plot! 
```{r}

library(viridis)
# color = viridis(n = length(seabirds))
# plot(run1$annual_BB[,1], ylab = "Predator Biomass", col = "White", xlab = "Time", ylim = c(0,0.004))
# for(i in 1:length(seabirds)) {
#   lines(run1$annual_BB[,seabirds[i]], col = color[i])
# }
# par(mar = c(4,4,2,6))
# legend("topright",legend = seabirds, lty = 1, col = color,
#        inset=c(-0.35,0),  xpd = TRUE, cex = 0.5)

change_overtime_plot <- function(species) {
  x = seq(0,1, length.out = length(species))
  color = viridis(n = length(species))
  par(mar = c(6,12,2,4))
  specieyear1 = run1$annual_BB[1, species]
  specieyearlast = run1$annual_BB[length(yearlist), species]
  plot(rev(specieyearlast/specieyear1),x, ylab = "", bg = rev(color), col = "Black",
       xlab = "Biomass proportion", ylim = c(0,1), pch = 21,
       xlim = c(0,1.6), axes = F, frame = F)
  
  axis(2, at =x, labels = rev(species), las = 2, pos = 0, cex.axis = 1.5)
  axis(1, at=c(0.2, 0.4, 0.6, 0.8, 1, 1.2, 1.4, 1.6, 1.8), cex.axis=1, tck=0.01, pos = -0.05)
  abline(v = 1, lty =3)

}
change_overtime_plot(seabirds)
change_overtime_plot(mammals)
change_overtime_plot(pred_fish)

forage <- Cal_bal$Group[19:27] 
change_overtime_plot(forage)

random = c(Cal_bal$Group[7], Cal_bal$Group[19:22],
           Cal_bal$Group[40:47])
change_overtime_plot(random)

```

# Fish down and recovery scenario, fish for 25 years and stop and look at how popualtion recovers
```{r}
# helper function to look up the ending biomass of a scenario
end_biomass <- function(rsim){return(rsim$out_BB[dim(rsim$out_BB)[1], 2:(dim(rsim$out_BB)[2])])}
end_biomass
scene2 <- base_sim_scene
scene2 <- adjust.fishing(scene2, "FRATE", "Anchovy", 2000:2020, value=2.0)
scene2 <- adjust.fishing(scene2, "FRATE", "Sardine", 2020:2050, value=1.0)
run2   <- rsim.run(scene2, method='AB', years=yearlist)
rsim.plot(run2,all_species) 

end_biomass(run3)['mesopelagics']


```

# After the year 2000, run each year separately, setting each year's target
# fishing rates based on inperfect (randomized) assessment.
```{r}
#The issue was: We were running the initial run for the entire time series so the rsim.step was tryign to overwrite the data that was already there, when running a multistep run your initial run is up to the point of your first break

target_sp <- "mesopelagics"
target_F <- 0.75
names(target_F) <- target_sp 

library(data.table)
scene3 <- copy(base_sim_scene)
run3 <- rsim.run(scene3, method = 'AB', years=2000)
for (yr in 2001:2050){
  # stock assessment based on current biomass * error
  assessment <- end_biomass(run3)[target_sp] * (runif(length(target_sp)) + 0.5)
  assessment
  
  # convert target F * assessment to a total catch 
  catches <- target_F * assessment
  
  # apply each catch to each species
  for (sp in target_sp){
    scene3 <- adjust.fishing(scene3, "CATCH", sp, yr, value=catches[sp])
  }
  # run 1 year
  run3 <- rsim.step(scene3, run3, method='AB', year.end=yr) 
}  
rsim.plot(run3,all_species)    



```



