---
title: "100 Rsim runs"
output: html_document
---

#
```{r}
library(dplyr)
library(readr)
library(Rpath)
library(data.table)
```

```{r}
GroupInfo_CalCur_USE <- read.csv("../Data/Groupinfo_CalCur-USE.csv")  
Diet_CalCur_USE <- read.csv("../Data/Diet_CalCur_USE.csv")  

## need to add row and column names from example files
base_list <-list.files(path = "../Data/500BaseParameters/",
               pattern = "*.csv", 
               full.names = T)
diet_list <-list.files(path = "../Data/DietMatrices/",
               pattern = "*.csv", 
               full.names = T)
Cbase_list <- list()
Cdiet_list <- list()

#Add columns to base parameters
groups <- GroupInfo_CalCur_USE %>%
  select(Group, Type, Unassim, BioAcc, ProdCons, DetInput, DetritusFate, Fleet1_Discards) %>%
  mutate(X = 1:94)
groups

#Extract row 94 from Group info (Fleet 1)
Fleet1 <- GroupInfo_CalCur_USE[94, ] %>% select(Biomass, EE, PB, QB, Fleet1_Landings) %>% mutate(X= 94)

#Rename rows in diet files 
groups2 <- Diet_CalCur_USE %>% select(DIETS) %>% mutate(X= 1:94)

#Rename columns in diet file
group_vector <- groups2$DIETS[1:92]
group_vector <- as.data.frame(c("DIETS", group_vector))
group_vector <- groups2[,"DIETS"]

test <- read_csv("../Data/DietMatrices/diet100227.csv")
test_vector <- colnames(test)[1:93]

#First loop for group: rename columns, add Fleet 1 row (assigned position X=94), add new parameters (columns) onto dataset, redu column order
for (i in 1:500) {
 Cbase_list[[i]] <- read.csv(base_list[i]) %>% 
    rename(Biomass = "V1", PB = "V2", QB = "V3", EE = "V4", Fleet1_Landings = "V5")
 Cbase_list[[i]] <- bind_rows(Fleet1, Cbase_list[[i]]) %>% arrange(X) %>% left_join(groups, by= "X") %>% select(-X) %>% relocate(Group)
col_order <- c("Group", "Biomass", "EE", "PB", "QB", "Type", "Unassim", "BioAcc", "ProdCons", "DetInput", "DetritusFate", "Fleet1_Landings", "Fleet1_Discards")
Cbase_list[[i]] <- Cbase_list[[i]][, col_order]
write.csv(Cbase_list[[i]], paste("output", base_list[i]))
}

z<- read_csv(base_list[1])

colnamesgroups<- c("DIETS", group_vector[1:93])
#Diet matrices: #REMOVE IMPORT ROW??? ROW 94 (V93) IN TEST DATA
for (i in 1:500) {
Cdiet_list[[i]] <- read_csv(diet_list[i], col_names = colnamesgroups ) %>% select(-Detritus)
Cdiet_list[[i]]<- Cdiet_list[[i]][-1,]
Cdiet_list[[i]] <- Cdiet_list[[i]] %>%
  mutate(DIETS = c(colnamesgroups[2:94], "Import"))
write.csv(Cdiet_list[[i]], diet_list[i])
z2 <- read_csv(diet_list[1])
}
```

```{r}
read.rpath.params2 <- function(modfile, dietfile, pedfile = NA,
                              stanzagroupfile = NA, stanzafile = NA){
  #Need to define variables to eliminate check() note about no visible binding
  Type <- Group <- V1 <- NULL
  
  Rpath.params <- list()
  
  Rpath.params$model <- as.data.table(read.csv(modfile,  header = T)) %>%
    select(-X) 
  Rpath.params$model[Rpath.params$model == -1] <- NA
   Rpath.params$model[Rpath.params$model[93, 5]] <- NA

  
  Rpath.params$diet  <- as.data.table(read.csv(dietfile, header = T)) %>%
    select(-X)
  
  
  if(!is.na(stanzagroupfile)){
    stanzagroup <- as.data.table(read.csv(stanzagroupfile, header = T))
    Rpath.params$stanzas$NStanzaGroups <- nrow(stanzagroup)
    Rpath.params$stanzas$stgroups      <- stanzagroup
    Rpath.params$stanzas$stindiv       <- as.data.table(read.csv(stanzafile, 
                                                                 header = T))
  } else {
    Rpath.params$stanzas$NStanzaGroups <- 0
    Rpath.params$stanzas$stgroups      <- data.table(StGroupNum  = NA,
                                                     StanzaGroup = NA,
                                                     nstanzas    = NA,
                                                     VBGF_Ksp    = NA,
                                                     VBGF_d      = NA,
                                                     Wmat        = NA,
                                                     RecPower    = NA,
                                                     Wmat001     = NA,
                                                     Wmat50      = NA,
                                                     Amat001     = NA,
                                                     Amat50      = NA)
    Rpath.params$stanzas$stindiv       <- data.table(StGroupNum   = NA,
                                                     StanzaNum   = NA,
                                                     GroupNum    = NA,
                                                     Group       = NA,
                                                     First       = NA,
                                                     Last        = NA,
                                                     Z           = NA,
                                                     Leading     = NA)
  }
  if(!is.na(pedfile)){
    Rpath.params$pedigree <- as.data.table(read.csv(pedfile, header = T))
  } else {
    Rpath.params$pedigree <- data.table(Group = Rpath.params$model$Group,
                                        B     = 1,
                                        PB    = 1,
                                        QB    = 1,
                                        Diet  = 1)
    fleets <- as.character(Rpath.params$model[Type == 3, Group])
    for(i in 1:length(fleets)){
      Rpath.params$pedigree[, V1 := 1]
      setnames(Rpath.params$pedigree, 'V1', fleets[i])
    }
  }
  class(Rpath.params) <- 'Rpath.params'
  return(Rpath.params)
}
```


```{r}
  Cbase <-  base_list[[1]] # Base biomass, production, fishing, etc.
  Cdiet <- diet_list[[1]] # Diet matrix

  CalCur_unbal <- read.rpath.params(Cbase, Cdiet)
  CalCur_unbal[[1]] <- CalCur_unbal[[1]] %>%
    select(-X)
  CalCur_unbal[[1]][93, 5] <- NA
  CalCur_unbal[[1]][CalCur_unbal[[1]] == -1] <- NA
   CalCur_unbal[[2]] <- CalCur_unbal[[2]] %>%
    select(-X)
  check.rpath.params(CalCur_unbal)
```




```{r}
for (i in 1:500) {
  Cbase <-  base_list[[i]] # Base biomass, production, fishing, etc.
  Cdiet <- diet_list[[i]] # Diet matrix

  CalCur_unbal <- read.rpath.params2(Cbase, Cdiet)
  check.rpath.params(CalCur_unbal)


  Cal_bal   <- rpath(CalCur_unbal) 


  cbind(Cal_bal$Group, Cal_bal$EE)
  cbind(Cal_bal$Group, Cal_bal$TL) 
  #Define different functional groups
  all_species <- Cal_bal$Group[1:92] 
  mammals <- Cal_bal$Group[71:85] 
  seabirds <- c(Cal_bal$Group[60:70], Cal_bal$Group[86:92])
  pred_fish  <- Cal_bal$Group[33:59] 
  forage <- Cal_bal$Group[19:27]

  yearlist = 2001:2050

  base_sim_scene <- rsim.scenario(Cal_bal, CalCur_unbal, years = yearlist)

# Baseline (equilibrium) run, make a copy of the baseline scenario
  scene0 <- base_sim_scene

  run0[[i]]   <- rsim.run(scene0, method='AB', years=yearlist) 
}
```

