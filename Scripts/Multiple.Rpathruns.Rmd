---
title: "100 Rsim runs"
output: html_document
---

#
```{r}
library(dplyr)
library(readr)
library(Rpath)
library(data.table)
```

#Load this each time 
```{r}
GroupInfo_CalCur_USE <- read.csv("../Data/Groupinfo_CalCur-USE.csv")  
Diet_CalCur_USE <- read.csv("../Data/Diet_CalCur_USE.csv")  

## need to add row and column names from example files
base_list <-list.files(path = "../Data/500BaseParameters/",
               pattern = "*.csv", 
               full.names = T)
diet_list <-list.files(path = "../Data/DietMatrices/",
               pattern = "*.csv", 
               full.names = T)
Cbase_list <- list()
Cdiet_list <- list()
```

#Don't need to run this again!! 
```{r}
#Add columns to base parameters
groups <- GroupInfo_CalCur_USE %>%
  select(Group, Type, Unassim, BioAcc, ProdCons, DetInput, DetritusFate, Fleet1_Discards) %>%
  mutate(X = 1:94)
groups

#Extract row 94 from Group info (Fleet 1)
Fleet1 <- GroupInfo_CalCur_USE[94, ] %>% select(Biomass, EE, PB, QB, Fleet1_Landings) %>% mutate(X= 94)

#Rename rows in diet files 
groups2 <- Diet_CalCur_USE %>% select(DIETS) %>% mutate(X= 1:94)

#Rename columns in diet file
group_vector <- groups2$DIETS[1:92]
group_vector <- as.data.frame(c("DIETS", group_vector))
group_vector <- groups2[,"DIETS"]

test <- read_csv("../Data/DietMatrices/diet100227.csv")
test_vector <- colnames(test)[1:93]

#First loop for group: rename columns, add Fleet 1 row (assigned position X=94), add new parameters (columns) onto dataset, redu column order
#for (i in 1:500) {
 Cbase_list[[i]] <- read.csv(base_list[i]) %>% 
    rename(Biomass = "V1", PB = "V2", QB = "V3", EE = "V4", Fleet1_Landings = "V5")
 Cbase_list[[i]] <- bind_rows(Fleet1, Cbase_list[[i]]) %>% arrange(X) %>% left_join(groups, by= "X") %>% select(-X) %>% relocate(Group)
col_order <- c("Group", "Biomass", "EE", "PB", "QB", "Type", "Unassim", "BioAcc", "ProdCons", "DetInput", "DetritusFate", "Fleet1_Landings", "Fleet1_Discards")
Cbase_list[[i]] <- Cbase_list[[i]][, col_order]
write.csv(Cbase_list[[i]], paste("output", base_list[i]))
}

z<- read_csv(base_list[1])

colnamesgroups<- c("DIETS", group_vector[1:93])
#Diet matrices: #REMOVE IMPORT ROW??? ROW 94 (V93) IN TEST DATA
#for (i in 1:500) {
Cdiet_list[[i]] <- read_csv(diet_list[i], col_names = colnamesgroups ) %>% select(-Detritus)
Cdiet_list[[i]]<- Cdiet_list[[i]][-1,]
Cdiet_list[[i]] <- Cdiet_list[[i]] %>%
  mutate(DIETS = c(colnamesgroups[2:94], "Import"))
write.csv(Cdiet_list[[i]], diet_list[i])
}

z2 <- read_csv(diet_list[1])

```

#Loop through 500 data sets!! 

#Reading in data, unbalanced model
```{r}
CalCur_unbal2_list <- list() #Creating an empty list to store vectors so can index 

  for (i in 1:500) {
  Cbase2 <-  base_list[[i]] 
  Cdiet2 <- diet_list[[i]]

  #Edit the datasets
  CalCur_unbal2_list[[i]] <- read.rpath.params(Cbase2, Cdiet2)
  CalCur_unbal2_list[[i]][[1]] <- CalCur_unbal2_list[[i]][[1]] %>%
    select(-X)
  CalCur_unbal2_list[[i]][[1]][93, 5] <- NA
  CalCur_unbal2_list[[i]][[1]][CalCur_unbal2_list[[i]][[1]] == -1] <- NA
   CalCur_unbal2_list[[i]][[2]] <- CalCur_unbal2_list[[i]][[2]] %>%
    select(-X)

  check.rpath.params(CalCur_unbal2_list[[i]])
  }
CalCur_unbal2_list[[450]]

```
 
#Creating a balanced Ecopath model 
```{r}
Cal_bal2 <- list()
for (i in 1:500) {
Cal_bal2[[i]] <- rpath(CalCur_unbal2_list[[i]]) 
  cbind(Cal_bal2[[i]]$Group, Cal_bal2[[i]]$EE)
  cbind(Cal_bal2[[i]]$Group, Cal_bal2[[i]]$TL) 
}
```

#Creating base scenario 
```{r}
 #Define different functional groups
  all_species <- Cal_bal$Group[1:92] 
  mammals <- Cal_bal$Group[71:85] 
  seabirds <- c(Cal_bal$Group[60:70], Cal_bal$Group[86:92])
  pred_fish  <- Cal_bal$Group[33:59] 
  forage <- Cal_bal$Group[19:27]

  #Base scenario
  base_sim_scene2 <- list()
  scene0.2 <- list()
  run0.2 <- list()
  for (i in 1:500) {
  yearlist = 2001:2050

base_sim_scene2[[i]] <- rsim.scenario(Cal_bal2[[i]], CalCur_unbal2_list[[i]], years = yearlist)
scene0.2[[i]] <- base_sim_scene2[[i]]
run0.2[[i]] <- rsim.run(scene0.2[[i]], method='AB', years=yearlist) 
#rsim.plot(run0[[i]], all_species) #This isn't working
  }

rsim.plot(run0.2[[500]])

```

#End biomass
```{r}
end_biomass <- function(rsim){return(rsim$out_Biomass[dim(rsim$out_Biomass)[1], 2:(dim(rsim$out_Biomass)[2])])}
end_biomass
```

#Apply 25% harvest rate 
```{r}

target_sp <- "mesopelagics"
target_F <- 0.25
names(target_F) <- target_sp 

scene6.2 <- list()
run6.2 <- list()
assessment2 <- list()
catches2 <- list()
year <- seq(2002,2050)


for (i in 1:500) {
for(j in 1:49){
scene6.2[[i]] <- copy(base_sim_scene2[[i]])
run6.2[[i]] <- rsim.run(scene6.2[[i]], method = 'AB', years=2001)
assessment2[[i]] <- end_biomass(run6.2[[i]])[target_sp] * (runif(length(target_sp)) + 0.5) #argument of length 0 means input is of length zero 
assessment2[[i]]
  # convert target F * assessment to a total catch 
  catches2[[i]] <- target_F * assessment2[[i]]
  # apply each catch to each species
  for (sp in target_sp){
    scene6.2[[i]] <- adjust.fishing(scene6.2[[i]], "ForcedCatch", sp, year[[j]], value=catches2[[i]][sp])
  } 
  # run 1 year
  run6.2[[i]] <- rsim.step(scene6.2[[i]], run6.2[[i]], method = 'AB', year.end= year[[j]])  
}  
}
rsim.plot(run6.2[[1]], all_species)
run6.2[[1]]

```

#Changing data set so we can change plotting

```{r}
rsim.plot.fun <- function(Rsim.output, spname, indplot = F, ...){
  opar <- par(no.readonly = T)
  if(indplot == F){
    biomass <- Rsim.output$out_Biomass[, 2:ncol(Rsim.output$out_Biomass)]
    n <- ncol(biomass)
    start.bio <- biomass[1, ]
    start.bio[which(start.bio == 0)] <- 1
    rel.bio <- matrix(NA, dim(biomass)[1], dim(biomass)[2])
    for(isp in 1:n) rel.bio[, isp] <- biomass[, isp] / start.bio[isp]
  }
  rel.bio
} 

names_spp<- run6$params$spname[2:94]

#Need to make z into data frame, before was matrix, names is for data frame not matrix
#Ways to do this in tidy verse but this is quick fix
z_6 <-rsim.plot.fun(run6)
z_6<-as.data.frame(z_6)
names(z_6) <- names_spp
z_6$month <- 1:600

data_6 <- gather(z_6, key = spp, value = biomass, -month )

```







 
  

