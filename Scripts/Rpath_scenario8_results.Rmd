---
title: "Rpath.scenario8.results"
output: html_document
---

#Exploring input uncertainty by simulating 500 Rsim scenarios with a yearly 25% harvest rate on mesopelagic fish in the California Current (scenario 8) with parameters taken from 500 Ecopath models generated by Monte Carlo draws in Koehn et al. (2016) (scenario 8). Code was created by Sally Dowd (sdowd20@berkeley.edu) and Melissa Chapman (mchapman@berkeley.edu) with guidance and datasets from Laura Koehn (laura.koehn216@gmail.com). 

#Load required packages
```{r}
library(dplyr)
library(readr)
library(Rpath)
library(data.table)
library(tidyr)
library(ggplot2)
library(ggpubr)
```

#Import original diet matrix (Diet_CalCur_USE.csv) and an unbalanced version of base parameters (Groupinfo_CalCur-USE.csv) and then the 500 diet matrices and unbalanced versions of base parameters from the Monte Carlo analysis in Koehn et al. (2016). 
```{r}
GroupInfo_CalCur_USE <- read.csv("../Data/Groupinfo_CalCur-USE.csv")  
Diet_CalCur_USE <- read.csv("../Data/Diet_CalCur_USE.csv")  

base_list <-list.files(path = "../Data/500BaseParameters/",
               pattern = "*.csv", 
               full.names = T)
diet_list <-list.files(path = "../Data/DietMatrices/",
               pattern = "*.csv", 
               full.names = T)
Cbase_list <- list()
Cdiet_list <- list()
```

#Modify original datasets from Koehn et al. (2016) to run with the Rpath package. Through running this code, we modified the original files from Koehn et al. (2016) so they would run with the Rpath package. We no longer need to run this code as the 500.base.parameters and 500.group.info folders now contain the updated files. 
```{r}
#Add columns to base parameters
#groups <- GroupInfo_CalCur_USE %>%
 # select(Group, Type, Unassim, BioAcc, ProdCons, DetInput, DetritusFate, Fleet1_Discards) %>%
  #mutate(X = 1:94)
#groups

#Extract row 94 from Group info (Fleet 1)
#Fleet1 <- GroupInfo_CalCur_USE[94, ] %>% select(Biomass, EE, PB, QB, Fleet1_Landings) %>% mutate(X= 94)

#Rename rows in diet files 
#groups2 <- Diet_CalCur_USE %>% select(DIETS) %>% mutate(X= 1:94)

#Rename columns in diet file
#group_vector <- groups2$DIETS[1:92]
#group_vector <- as.data.frame(c("DIETS", group_vector))
#group_vector <- groups2[,"DIETS"]

#test <- read_csv("../Data/DietMatrices/diet100227.csv")
#test_vector <- colnames(test)[1:93]

#First loop for group: rename columns, add Fleet 1 row (assigned position X=94), add new parameters (columns) onto dataset, redu column order
#for (i in 1:500) {
# Cbase_list[[i]] <- read.csv(base_list[i]) %>% 
    #rename(Biomass = "V1", PB = "V2", QB = "V3", EE = "V4", Fleet1_Landings = "V5")
 #Cbase_list[[i]] <- bind_rows(Fleet1, Cbase_list[[i]]) %>% arrange(X) %>% left_join(groups, by= "X") %>% select(-X) %>% relocate(Group)
#col_order <- c("Group", "Biomass", "EE", "PB", "QB", "Type", "Unassim", "BioAcc", "ProdCons", "DetInput", "DetritusFate", "Fleet1_Landings", "Fleet1_Discards")
#Cbase_list[[i]] <- Cbase_list[[i]][, col_order]
#write.csv(Cbase_list[[i]], paste("output", base_list[i]))
#}

#z<- read_csv(base_list[1])

#colnamesgroups<- c("DIETS", group_vector[1:93])
#Diet matrices: #REMOVE IMPORT ROW??? ROW 94 (V93) IN TEST DATA
#for (i in 1:500) {
#Cdiet_list[[i]] <- read_csv(diet_list[i], col_names = colnamesgroups ) %>% select(-Detritus)
#Cdiet_list[[i]]<- Cdiet_list[[i]][-1,]
#Cdiet_list[[i]] <- Cdiet_list[[i]] %>%
 # mutate(DIETS = c(colnamesgroups[2:94], "Import"))
#write.csv(Cdiet_list[[i]], diet_list[i])
#}

#z2 <- read_csv(diet_list[1])
```

#Read in each diet matrix and base list dataest pair to form the 500 unbalanced models. 
```{r}
CalCur_unbal2_list <- list() 

for (i in 1:500) {
Cbase2 <-  base_list[[i]] 
Cdiet2 <- diet_list[[i]]

#Edit the datasets
  CalCur_unbal2_list[[i]] <- read.rpath.params(Cbase2, Cdiet2)
  CalCur_unbal2_list[[i]][[1]] <- CalCur_unbal2_list[[i]][[1]] %>%
    select(-X)
  CalCur_unbal2_list[[i]][[1]][93, 5] <- NA
  CalCur_unbal2_list[[i]][[1]][CalCur_unbal2_list[[i]][[1]] == -1] <- NA
  CalCur_unbal2_list[[i]][[2]] <- CalCur_unbal2_list[[i]][[2]] %>%
  select(-X)

  check.rpath.params(CalCur_unbal2_list[[i]])
  }
```

#Create 500 balanced Ecopath objects and convert these to Rpath objects
```{r}
Cal_bal2 <- list()
for (i in 1:500) {
Cal_bal2[[i]] <- rpath(CalCur_unbal2_list[[i]]) 
  cbind(Cal_bal2[[i]]$Group, Cal_bal2[[i]]$EE)
  cbind(Cal_bal2[[i]]$Group, Cal_bal2[[i]]$TL) 
}
```

#Initialize 500 base scenarios through a loop 
```{r}
#Define species
  all_species <- Cal_bal$Group[1:92] 

yearlist = 2001:2050 #year range for simulations  

base_sim_scene2 <- list()
scene0.2 <- list()
run0.2 <- list()
for (i in 1:500) {
base_sim_scene2[[i]] <- rsim.scenario(Cal_bal2[[i]], CalCur_unbal2_list[[i]], years = yearlist)
scene0.2[[i]] <- base_sim_scene2[[i]]
run0.2[[i]] <- rsim.run(scene0.2[[i]], method='AB', years=yearlist) 
  }
```

#Scenario 8: Apply a yearly 25% mesopelagic fish harvest rate to the 500 base Rsim scenarios and project the simulation forward for fifty years
```{r}
target_sp <- "mesopelagics"
target_F <- 0.25
names(target_F) <- target_sp 

scene6.2 <- list()
run6.2 <- list()
assessment2 <- list()
catches2 <- list()
for (i in 1:500){
  scene6.2[[i]] <- copy(base_sim_scene2[[i]])
  run6.2[[i]] <- rsim.run(scene6.2[[i]], method = 'AB', years=2001)
  for (yr in 2002:2050){
  #Perform a stock assessment based on current biomass*error
    assessment2[[i]] <- end_biomass(run6.2[[i]])[target_sp] * (runif(length(target_sp)) +
    0.5) 
    assessment2[[i]]
    #Calculate total catch by multiplying target harvest rate by assessment
   catches2[[i]] <- target_F * assessment2[[i]]
   #apply the calculated catch to mesopelagic fish
    for (sp in target_sp){
    scene6.2[[i]] <- adjust.fishing(scene6.2[[i]], "ForcedCatch", sp, yr,
    value=catches2[[i]][sp])
  }
  #run 1 year
  run6.2[[i]] <- rsim.step(scene6.2[[i]], run6.2[[i]], method = 'AB', year.end=yr)
}  
  }
```

#Change datasets from an Rpath object to a dataframe in order to plot with ggplot2
```{r}
rsim.plot.fun <- function(Rsim.output, spname, indplot = F, ...){
  opar <- par(no.readonly = T)
  if(indplot == F){
    biomass <- Rsim.output$out_Biomass[, 2:ncol(Rsim.output$out_Biomass)]
    n <- ncol(biomass)
    start.bio <- biomass[1, ]
    start.bio[which(start.bio == 0)] <- 1
    rel.bio <- matrix(NA, dim(biomass)[1], dim(biomass)[2])
    for(isp in 1:n) rel.bio[, isp] <- biomass[, isp] / start.bio[isp]
  }
  rel.bio
} 

names_spp.2 <- run2$params$spname[2:94]
z_6.2 <- list()
data_6.2 <- list()
for (i in 1:500) {
z_6.2[[i]] <- rsim.plot.fun(run6.2[[i]])
z_6.2[[i]] <- as.data.frame(z_6.2[[i]])
names(z_6.2[[i]]) <- names_spp.2
z_6.2[[i]]$month <- 1:600
data_6.2[[i]] <- gather(z_6.2[[i]], key = spp, value = biomass, -month)
data_6.2[[i]] <- data_6.2[[i]] %>% filter(month==600) %>% mutate(X= i)
}

#Combine the datasets from the loop into one and remove the 7 models that are outliers as they produced unrealistic biomass projections 
entire_data_6 <- bind_rows(data_6.2) %>% filter(X == 67)
entire_data_6 <- bind_rows(data_6.2) %>% filter(!X %in% c(67, 126, 237, 343, 396, 430, 472)) %>% arrange(spp)
entire_data_6 <- transform(entire_data_6,ID=as.numeric(factor(spp))) #Add column for ID that correlates to each different species 

write.csv(entire_data_6, "/Users/sallydowd/Documents/GitHub/mesopelagic-fishing/Data/Scenario_8.csv")
```

#Confidence intervals: Calculate the 95% CI for the relative end biomass of each functional group at the end of the simulation (month 600). 
```{r}
scenario_8 <- read.csv("/Users/sallydowd/Documents/GitHub/mesopelagic-fishing/Data/Scenario_8.csv")

n <- 500
t_star <- 1.960
sample_mean <- list()
sd_error <- list()
CI_lower <- list()
CI_upper <- list()

for (i in unique(scenario_8$ID)){
subdf <- subset(x=scenario_8, subset=ID==i)
sample_mean[[i]] <- mean(subdf$biomass)
sd_error[[i]] <- (sd(subdf$biomass))/(sqrt(n))
CI_lower[[i]] <- sample_mean[[i]] - (t_star*sd_error[[i]])
CI_upper[[i]] <- sample_mean[[i]] + (t_star*sd_error[[i]])
}

df2 <- as.data.frame(do.call(rbind, CI_upper)) %>% rename("CI_upper" = V1) %>% mutate(ID = 1:93)
df1 <- as.data.frame(do.call(rbind, CI_lower)) %>% rename("CI_lower"= V1) %>% mutate(ID = 1:93) %>% left_join(df2, by = "ID") %>% relocate(ID)

#Calculate quantiles
  quantile_0.025 <- list()
  quantile_0.975 <- list()
  
  for (i in unique(scenario_8$ID)){
  subdf2 <- subset(x=scenario_8, subset=ID==i)
  quantile_0.025[[i]] <- quantile(subdf2$biomass, 0.025)
  quantile_0.975[[i]] <- quantile(subdf2$biomass, 0.975)
  }

  df_quant2 <- as.data.frame(do.call(rbind, quantile_0.975)) %>% mutate(ID = 1:93)
  df_quant1 <- as.data.frame(do.call(rbind, quantile_0.025)) %>% mutate(ID = 1:93) %>%
  left_join(df_quant2, by = "ID") %>% relocate("ID")
  
  sum_data_6 <- scenario_8 %>% group_by(spp, ID) %>% summarise(mean_biomass =
  mean(biomass), sd_biomass= sd(biomass), median_biomass = median(biomass)) %>%
  left_join(df1, by = "ID")
  sum_data_6 <- sum_data_6 %>% left_join(df_quant1, by = "ID") %>% rename(quant_2.5 =
  "2.5%", quant_97.5 = "97.5%")
  
sum_data_6 <- sum_data_6 %>% mutate("median.value" = cut(median_biomass, 
                        breaks = c(-Inf, 1, Inf),
                        labels = c("Decreasing", "Increasing"),
                        right = TRUE), "difference"= quant_97.5-quant_2.5)
  
write.csv(sum_data_6, "/Users/sallydowd/Documents/OTZ.manuscript/Excel/Scenario_8_quantiles.csv")
```

#Check to see if the seven datasets that produce unrealistic biomass estimates are outliers 
```{r}
rest_of_models_outliers <- scenario_8 %>% group_by(spp) %>% summarize(IQR_biomass = IQR(biomass), quantile_lower = quantile(biomass, 0.25), quantile_upper = quantile(biomass, 0.75)) %>% mutate(lower_outlier = quantile_lower - (1.5*IQR_biomass), upper_outlier= quantile_upper + (1.5*IQR_biomass)) 

seven_models_outliers <- bind_rows(data_6.2) %>% filter(X %in% c(67, 126, 237, 343, 396, 430, 472)) %>% arrange(X)
seven_models_outliers <- transform(seven_models_outliers, ID.X=as.numeric(factor(X))) 
seven_models_outliers <- seven_models_outliers %>% spread(ID.X, biomass) %>% rename("model1"= "1", "model2"= "2", "model3"= "3", "model4"= "4", "model5"= "5", "model6"= "6", "model7" = "7")

#Each species final biomass in each of the 7 models are outliers 
test <- seven_models_outliers %>% left_join(rest_of_models_outliers) %>% mutate(outlier1 = ifelse(model1 < lower_outlier|model1 > upper_outlier, TRUE, FALSE), outlier2 = ifelse(model2 < lower_outlier|model2 > upper_outlier, TRUE, FALSE), outlier3 = ifelse(model3 < lower_outlier|model3 > upper_outlier, TRUE, FALSE), outlier4 = ifelse(model4 < lower_outlier|model4 > upper_outlier, TRUE, FALSE), outlier5 = ifelse(model5 < lower_outlier|model5 > upper_outlier, TRUE, FALSE), outlier6 = ifelse(model6 < lower_outlier|model6 > upper_outlier, TRUE, FALSE), outlier7 = ifelse(model7 < lower_outlier|model7 > upper_outlier, TRUE, FALSE))
```

#Change over time graphs for scenario 8 for all functional groups (with the exception of mesopelagic fish) to create Figure 3a-b in the paper and Appendix S3: Figure S2 in the supplementary material. The relative end biomass on the x axis the biomass at the end of the simulation in 2050 (month 600). 
```{r}
standard_theme <- theme_bw() + theme(panel.border = element_rect(fill=NA, colour = "black", size=1)) + 
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + theme(legend.text.align= 0, legend.title= element_text(size = 10), legend.text = element_text(size= 9), axis.text=element_text(size=8), axis.title=element_text(size=10)) + theme(axis.text.y = element_text(hjust= 0.95))

scenario_8_quantiles <- read.csv("/Users/sallydowd/Documents/GitHub/mesopelagic-fishing/Data/Scenario_8_quantiles.csv")

 #Generate graph with functional groups with high diet dependence on mesopelagic fish: Diet over 0.05 (mesopelagic fish make up at least 5% of their diet)
  sum_2_1 <- scenario_8_quantiles %>% filter(spp %in% diet_over_0.05) %>% rename(species=
  "spp") %>% left_join(Predator_value, by= "species")
  sum_2_1[5,13] <- "Neither"
  sum_2_1$Value <- factor(sum_2_1$Value, levels = c("Commercial", "Non-commercial",
  "Both", "Neither"))
  sum_2_1_graph <- sum_2_1 %>% ggplot(aes(col= Value)) + 
  geom_pointrange(aes(y=reorder(species, median_biomass), x=median_biomass,
  xmin=quant_2.5, xmax= quant_97.5), size=0.5, shape=22, fill= "white") + 
  scale_color_manual(values = c("#FF0000","#0000FF", "#00FF70", "#FF00FF")) + 
  scale_y_discrete(labels= c("Tufted Puffin"= "Tufted puffin", "P. Ocean Perch"= "P. ocean perch", "Leach's S. Petrel"= "Leach's s. petrel", "Longspine thorny."= "Longspine thornyhead", "Shelf rock."= "Shelf rockfish", "Slope rock."= "Slope rockfish", "Yellowtail rock."= "Yellowtail rockfish")) + 
  geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) +
  xlim(0.70, 1.35) + xlab("Relative biomass") + ylab("Species with high diet proportion") + labs(col = "Classification") + standard_theme
  sum_2_1_graph

#Generate graph with functional groups with low diet dependence on mesopelagic fish: Diet under 0.05 (mesopelagic fish make up less than 5% of their diet)
  sum_2_2 <- scenario_8_quantiles %>% filter(spp %in% diet_under_0.05) %>%
  rename(species= "spp") %>% left_join(Predator_value, by= "species")
  #Remove mesopelagics
  sum_2_2 <- sum_2_2[-15,]
  sum_2_2$Value <- factor(sum_2_2$Value, levels = c("Non-commercial", "Both", "Neither"))
  sum_2_2_graph <- sum_2_2 %>% ggplot(aes(col= Value)) + 
   geom_pointrange(aes(y=reorder(species, median_biomass), x=median_biomass,
  xmin=quant_2.5, xmax= quant_97.5), size=0.5, shape=22, fill= "white") + 
  scale_color_manual(values = c("#0000FF", "#00FF70")) +
  scale_y_discrete(labels= c("Western Gull"= "Western gull", "Resident Orcas"= "Resident orcas", "Juv. Ele. Seal"= "Juv. n. elephant seal", "Greenstriped"= "Greenstriped rockfish", "Double corm."= "Double cormorant", "Brandt's corm."= "Brandt's cormorant","Arrowtooth"= "Arrowtooth flounder", "Canary rock."= "Canary rockfish", "Juv. rock."="Juv. rockfish", "Other cephal."= "Other cephalopod", "Shortspine thorny."= "Shortspine thornyhead", "Widow rock."= "Widow rockfish", "mesopelagics"= "Mesopelagics", "Sea Lions"= "Sea lions", "Splitnose rock."= "Splitnose rockfish")) +
  geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) +
  xlim(0.70, 1.35) + xlab("Relative biomass") + ylab("Species with low diet proportion") + labs(col = "Classification") + standard_theme 
  sum_2_2_graph

#Generate graph with functional groups with no diet dependence on mesopelagic fish. This means that these functional groups have 0% of their diet consist of mesopelagic fish. 
  commercial_predators_df <- as.data.frame(commercial_predators) %>% rename(species=       commercial_predators)
  noncommercial_predators_df <- as.data.frame(noncommerical_predators) %>% 
  rename(species= noncommerical_predators)
  combo <- rbind(commercial_predators_df, noncommercial_predators_df, by= "species") %>%
  mutate(Dependence= 1)
  sum_no_dependence <- scenario_8_quantiles %>% rename(species= "spp") %>%
  left_join(combo, by= "species")
  sum_no_dependence[is.na(sum_no_dependence)] <- 0 #Functional groups with no dependence on mesopelagics have a 0
  sum_no_dependence <-sum_no_dependence[!duplicated(sum_no_dependence$species),] 
  sum_no_dependence <- sum_no_dependence[-c(42,52),] #Remove mesopelagics and juvenile     hake- dependence on mesopelagics but don't have commercial or non-commercial value so will be weird with filtering
  sum_no_dependence_final <- sum_no_dependence %>% filter(Dependence==0)
  
  sum_2_3 <- sum_no_dependence_final
  sum_2_3_graph <- sum_2_3 %>% ggplot() + 
   geom_pointrange(aes(y=reorder(species, median_biomass), x=median_biomass,
  xmin=quant_2.5, xmax= quant_97.5), size=0.5, shape=22, fill= "white") + 
  scale_y_discrete(labels= c("Adult N. Ele. Seal"= "Adult n. elephant seal", "amphipods"=
  "Amphipods", "benthic shp"= "Benthic shrimp", "Brown Pelican"= "Brown pelican", "Cali.
  gull"= "California gull", "carniv-zoops" = "Carniv. zooplankton", "copepods"=
  "Copepods", "Dungeness"= "Dungeness crab", "epibenthic"= "Epibenthic", "euphausiids"=
  "Euphausiids", "infauna"= "Infauna", "Juv. round."= "Juv. roundfish", "Juv. thorny."=
  "Juv. thornyhead", "large jellies"= "Large jellies", "micro-zoop"= "Microzooplankton",
"Pacific Mackerel"= "Pacific mackerel",
  "pandalid shp"= "Pandalid shrimp", "phytoplankton"= "Phytoplankton", "Pigeon
  Guillemot"= "Pigeon guillemot", "Rhino. auk"= "Rhinoceros auklet", "small jellies"=
  "Small jellies", "surf perch"= "Surf perch", "tanner crb"= "Tanner crab", "Transient
  Orcas"= "Transient orcas", "Juv. flatfish"= "Juv. flat.", "Cali. gull" = "California gull")) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) +
  xlim(0.70, 1.35) + xlab("Relative biomass") + ylab("Species with low diet proportion") + labs(col = "Classification") + standard_theme 
  sum_2_3_graph

#Combining scenario 6,7 and 8 plots. The code to generate scenario 6 and 7 plots can be found in Rpath.main.results.Rmd.
  high_diet_plot <- ggarrange(change_2_1_plot + rremove("xlab") + rremove("ylab"),
  change_1_1_plot + rremove("xlab") + rremove("ylab"), common.legend = TRUE, legend=
  "right", labels= c("a", "b", "c"), sum_2_1_graph + rremove("xlab") + rremove("ylab"),
  ncol = 3, nrow = 1)
  
  annotate_figure(high_diet_plot, bottom= text_grob("Relative end biomass", size=14),
  left= text_grob("Species with high diet proportion", size=14, rot=90)) + 
  ggsave(width = 8.75, height = 5.25,
  "~/Documents/OTZ.Manuscript/Images/Submission.3/high.diet.combo.jpeg", dpi=600)
  
  low_diet_plot <- ggarrange(change_2_2_plot + rremove("xlab") + rremove("ylab") +
  rremove("legend"), change_1_2_plot + rremove("xlab") + rremove("ylab") +
  rremove("legend"), common.legend = TRUE, legend= "right", labels= c("a", "b", "c"),
  sum_2_2_graph + rremove("xlab") + rremove("ylab"), ncol = 3, nrow = 1)
  

  no_diet_plot <- ggarrange(change_2_3_plot + rremove("xlab") + rremove("ylab"),
  change_1_3_plot + rremove("xlab") + rremove("ylab"), sum_2_3_graph + rremove("xlab") +
  rremove("ylab"), ncol = 3, nrow = 1, labels= c("a", "b", "c"))
  
  annotate_figure(no_diet_plot, bottom= text_grob("Relative end biomass", size=14), left=
  text_grob("Species with no diet proportion", size=14, rot=90)) + 
  ggsave(width = 8.75, height = 5.25,
  "~/Documents/OTZ.Manuscript/Images/Submission.3/no.diet.combo.jpeg", dpi=600)
  
  high_low_diet_plot <- ggarrange(change_2_1_plot + rremove("xlab") + rremove("ylab"),
  change_1_1_plot + rremove("xlab") + rremove("ylab"), labels= c("a", "b", "c", "d", "e", "f"),   sum_2_1_graph + rremove("xlab") + rremove("ylab"),change_2_2_plot + rremove("xlab") +          rremove("ylab"), change_1_2_plot + rremove("xlab") + rremove("ylab"), sum_2_2_graph +          rremove("xlab") + rremove("ylab"), common.legend= TRUE, ncol = 3, nrow = 2) 
  
   annotate_figure(high_low_diet_plot, bottom= text_grob("Relative end biomass", size=14),
  left= text_grob("Species", size=14, rot=90)) + 
  ggsave(width = 8.75, height = 7,
  "~/Documents/OTZ.Manuscript/Images/Submission.3/high.low.diet.combo.jpeg", dpi=600)
  
```

```{r}
change_1_3 <- change_1_3 %>% mutate(Harvest = "25%")
change_2_3 <- change_2_3 %>% mutate(Harvest = "50")

ggplot() + geom_point(data= change_1_3, aes(x= biomass_prop, y= reorder(species, biomass_prop))) + geom_point(data= change_2_3, aes(x= biomass_prop, y= reorder(species, biomass_prop))) +
facet_grid(rows= vars(Harvest),scales="free")
```

