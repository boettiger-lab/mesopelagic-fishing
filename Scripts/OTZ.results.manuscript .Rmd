---
title: "OTZ.results.manuscript"
output: html_document
---

#Code to simulate the ecosystem-wide impacts of harvesting mesopelagic fishes on the California Current system
#Code was originally created by Kerim Aydin (kerim.aydin@noaa.gov), modified by Laura Koehn, Sally Dowd, and Melissa Chapman 

#Load required packages
```{r}
library(Rpath)
library(data.table)
library(tidyr)
library(dplyr)
library(readxl)
library(ggplot2)
library(tidyverse)
library(viridis)
```

#Import csv files 
```{r}
#Define code source for base and diet parameters
Cbase <- "../Data/Groupinfo_CalCur-USE.csv"  # Base biomass, production, fishing, etc.
Cdiet <- "../Data/Diet_CalCur_USE.csv"  # Diet matrix

#Load unbalanced Ecopath model
CalCur_unbal <- read.rpath.params(Cbase, Cdiet)

#Read in created parameter files with read.rpath.params function
check.rpath.params(CalCur_unbal)
```

#Running Ecopath in R: Balance an unbalanced Ecopath object, convert Ecopath model to Rpath object
```{r}
#Balance the scenario using rpath function 
Cal_bal <- rpath(CalCur_unbal) 
Cal_bal

#Combine two data frames into a single data frame 
cbind(Cal_bal$Group, Cal_bal$EE)
cbind(Cal_bal$Group, Cal_bal$TL) 
```
#Define different sets of functional groups
```{r}
all_species <- Cal_bal$Group[1:92] 
mammals <- Cal_bal$Group[71:85] 
seabirds <- c(Cal_bal$Group[60:70], Cal_bal$Group[86:92])
pred_fish  <- Cal_bal$Group[33:59] 
Plankton <- c(Cal_bal$Group[1], Cal_bal$Group[5:10])
forage <- Cal_bal$Group[19:27]

#All predators of mesopelagic fish 
predators_mesopelagic <- c(Cal_bal$Group[15], Cal_bal$Group[18], Cal_bal$Group[28:29], Cal_bal$Group[33], Cal_bal$Group[37:38], Cal_bal$Group[42:48], Cal_bal$Group[50:56], Cal_bal$Group[58:60], Cal_bal$Group[63], Cal_bal$Group[65:67], Cal_bal$Group[69:70], Cal_bal$Group[72:73], Cal_bal$Group[76:80], Cal_bal$Group[82], Cal_bal$Group[85:88])
predators_mesopelagic

#Commercially valuable predators of mesopelagic fish
commercial_predators <- c(Cal_bal$Group[18], Cal_bal$Group[33], Cal_bal$Group[37:38], Cal_bal$Group[42:48], Cal_bal$Group[50:56], Cal_bal$Group[58:59])
commercial_predators

#Non-commercially valuable predators of mesopelagic fish
noncommerical_predators <- c(Cal_bal$Group[18], Cal_bal$Group[28], Cal_bal$Group[33], Cal_bal$Group[37:38], Cal_bal$Group[43:47], Cal_bal$Group[50:56], Cal_bal$Group[58:60], Cal_bal$Group[63], Cal_bal$Group[65:67], Cal_bal$Group[69:70], Cal_bal$Group[72:73], Cal_bal$Group[76:80], Cal_bal$Group[82], Cal_bal$Group[85:88])
noncommerical_predators

#Predators that have a diet proportion of mesopelagic fish < 0.05
diet_under_0.05 <- c(Cal_bal$Group[15], Cal_bal$Group[18], Cal_bal$Group[28], Cal_bal$Group[37], Cal_bal$Group[43:47], Cal_bal$Group[50], Cal_bal$Group[52:53], Cal_bal$Group[55], Cal_bal$Group[58:59], Cal_bal$Group[60], Cal_bal$Group[65:67], Cal_bal$Group[69],Cal_bal$Group[72:73], Cal_bal$Group[77:80], Cal_bal$Group[82], Cal_bal$Group[86:88])

diet_under_0.05_2 <- c(Cal_bal$Group[15], Cal_bal$Group[18], Cal_bal$Group[28], Cal_bal$Group[37], Cal_bal$Group[43:47], Cal_bal$Group[50], Cal_bal$Group[52:53], Cal_bal$Group[55], Cal_bal$Group[58:59], Cal_bal$Group[60], Cal_bal$Group[65:67], Cal_bal$Group[69],Cal_bal$Group[72:73], Cal_bal$Group[77:80], Cal_bal$Group[82], Cal_bal$Group[86:88])
diet_under_0.05_2

#Predators that have a diet proportion of mesopelagic fish > 0.05
diet_over_0.05 <- c(Cal_bal$Group[29], Cal_bal$Group[33], Cal_bal$Group[38], Cal_bal$Group[42], Cal_bal$Group[48], Cal_bal$Group[51], Cal_bal$Group[54], Cal_bal$Group[56], Cal_bal$Group[63], Cal_bal$Group[70], Cal_bal$Group[76], Cal_bal$Group[85])
diet_over_0.05

#Predators of mesopelagic fish with annual economic value over $1/lb 
high.price <- c(Cal_bal$Group[47], Cal_bal$Group[45], Cal_bal$Group[38], Cal_bal$Group[55], Cal_bal$Group[46], Cal_bal$Group[43])
high.price
```

#Initialize a base scenario
```{r}
yearlist = 2001:2050

base_sim_scene <- rsim.scenario(Cal_bal, CalCur_unbal, years = yearlist)
scene0 <- base_sim_scene
run0 <- rsim.run(scene0, method='AB', years=yearlist) 
rsim.plot(run0,all_species)
```

#Function to look up the ending biomass of a scenario
```{r}
end_biomass <- function(rsim){return(rsim$out_Biomass[dim(rsim$out_Biomass)[1], 2:(dim(rsim$out_Biomass)[2])])}
end_biomass
```

#Scenario 7: Mesopelagic harvest level of 50%
#Run harvest scenario
```{r}
target_sp <- "mesopelagics" #Define target species
target_F <- 0.50 #Define target harvest rate 
names(target_F) <- target_sp 

scene1 <- copy(base_sim_scene)
run1 <- rsim.run(scene1, method = 'AB', years=2001)
for (yr in 2002:2050){
#Perform a stock assessment based on current biomass*error
assessment <- end_biomass(run1)[target_sp] * (runif(length(target_sp)) + 0.5)
assessment
#Calculate total catch by multiplying target harvest rate by assessment 
  catches <- target_F * assessment
  
#Apply catch to the target species
  for (sp in target_sp){
    scene1 <- adjust.fishing(scene1, "ForcedCatch", sp, yr, value=catches[sp])
  }
  #Run 1 year
  run1 <- rsim.step(scene1, run1, method='AB', year.end=yr) 
}  
rsim.plot(run1,all_species) 

#Modify dataset to plot with ggplot2
rsim.plot.fun <- function(Rsim.output, spname, indplot = F, ...){
  opar <- par(no.readonly = T)
  if(indplot == F){
    biomass <- Rsim.output$out_Biomass[, 2:ncol(Rsim.output$out_Biomass)]
    n <- ncol(biomass)
    start.bio <- biomass[1, ]
    start.bio[which(start.bio == 0)] <- 1
    rel.bio <- matrix(NA, dim(biomass)[1], dim(biomass)[2])
    for(isp in 1:n) rel.bio[, isp] <- biomass[, isp] / start.bio[isp]
  }
  rel.bio
} 

names_spp <- run1$params$spname[2:94]

#Make run1 a dataframe 
z_1 <-rsim.plot.fun(run1)
z_1<-as.data.frame(z_1)
names(z_1) <- names_spp
z_1$month <- 1:600
data_1 <- gather(z_1, key = spp, value = biomass, -month )

```

```{r}
#Scenario 6: Mesopelagic harvest level of 25%
target_sp <- "mesopelagics"
target_F <- 0.25
names(target_F) <- target_sp 

library(data.table)
scene2 <- copy(base_sim_scene)
run2 <- rsim.run(scene2, method = 'AB', years=2001)
for (yr in 2002:2050){
  # stock assessment based on current biomass * error
  # use this if including two species: assessment <- end_biomass(run3)[target_sp] * (runif(2) + 0.5)   
assessment <- end_biomass(run2)[target_sp] * (runif(length(target_sp)) + 0.5) #argument of length 0 means input is of length zero 
assessment
  # convert target F * assessment to a total catch 
  catches <- target_F * assessment
  # apply the catch to mesopelagic fish
  for (sp in target_sp){
    scene2 <- adjust.fishing(scene2, "ForcedCatch", sp, yr, value=catches[sp])
  }
  #run 1 year
  run2 <- rsim.step(scene2, run2, method = 'AB', year.end=yr)  
}  
rsim.plot(run2,all_species)  

#Modify data
names_spp <- run2$params$spname[2:94]
#Need to make run2 a data frame
z_2 <-rsim.plot.fun(run2)
z_2<-as.data.frame(z_2)
names(z_2) <- names_spp
z_2$month <- 1:600
data_2 <- gather(z_2, key = spp, value = biomass, -month )
data_2 %>% filter(spp== "mesopelagics")
```

#Change over time graphs for scenario 1 and 2 
```{r}
#Scenario 1




#Scenario 2
change_2_overtime_df <- function(species) {
  x = seq(0,1, length.out = length(species))
  color = viridis(n = length(species), option= "B")
  par(mar = c(6,12,2,4))
  specieyear2 = run2$annual_Biomass[1, species]
  specieyearlast = run2$annual_Biomass[length(yearlist), species]
  value <- (specieyearlast/specieyear2)
  cbind(species, value)
}
change_2_total <- change_2_overtime_df(all_species)
change_2_total <- as.data.frame(change_2_total)

#Higher dependence on mesopelagics: Diet over 0.05
change_2_1_df<- change_2_overtime_df(diet_over_0.05)
change_2_1_df <- as.data.frame(change_2_1_df)
change_2_1 <- change_2_1_df %>% mutate(value = round(as.numeric(paste(value)), 2), "result" = cut(value, 
                      breaks = c(-Inf, 0.99, 1.001, Inf),
                      labels = c("Decreasing", "Neither", "Increasing"),
                      right = TRUE)) %>% arrange(value)

Predator_value <- read_csv("Data/Predator.value.csv")
change_2_1 <- change_2_1 %>% rename(biomass_prop= value) %>% left_join(Predator_value, by="species")
change_2_1[9,4] <- "Neither"

change_2_1_plot <- change_2_1 %>% ggplot(aes(col = Value)) + geom_point(aes(x=biomass_prop, y=reorder(species, desc(species)))) + 
scale_colour_viridis(discrete= TRUE, option= "D") + 
 scale_y_discrete(labels= c("Tufted Puffin"= "Tufted puffin", "P. Ocean Perch"= "P. ocean perch", "Leach's S. Petrel"= "Leach's s. petrel", "Longspine thorny."= "Longspine thornyhead", "Shelf rock."= "Shelf rockfish", "Slope rock."= "Slope rockfish", "Yellowtail rock."= "Yellowtail rockfish")) + 
  geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) +
  xlim(0.75, 1.25) + 
xlab("Relative biomass") + ylab("Species with high diet proportion ") + labs(col = "End biomass", title= "A") + standard_theme + 
ggsave(width = 6, height = 5, "~/Documents/OTZ.manuscript/Images/dietover.25.jpeg")
change_2_1_plot 

#3: Lower dependence on mesopelagics: Diet under 0.05 

#TO NOTE: Mesopelagics currently are cut out of graph- need to make sure you have same scale for everything 
change_2_2_df <- change_2_overtime_df(diet_under_0.05_2)
change_2_2_df <- as.data.frame(change_2_2_df)
change_2_2 <- change_2_2_df %>% mutate(value = round(as.numeric(paste(value)), 2), "result" = cut(value, breaks = c(-Inf, 0.99, 1.001, Inf), labels = c("Decreasing", "Neither", "Increasing"), right = TRUE)) %>% arrange(value)
change_2_2 <- change_2_2 %>% rename(biomass_prop= value) %>% left_join(Predator_value, by="species") 
change_2_2[1,4] <- "Neither"
change_2_2_plot <- change_2_2 %>% ggplot(aes(col= Value)) + geom_point(aes(x= biomass_prop, y=reorder(species, desc(species)))) + 
  scale_colour_viridis(discrete= TRUE, option= "D") + 
 scale_y_discrete(labels= c("Western Gull"= "Western gull", "Resident Orcas"= "Resident orcas", "Juv. Ele. Seal"= "Juv. elephant seal", "Greenstriped"= "Greenstriped rockfish", "Double corm."= "Double cormorant",    "Brandt's corm."= "Brandt's cormorant", "Arrowtooth"= "Arrowtooth flounder", "Canary rock."= "Canary rockfish", "Juv. rock."= "Juvenile rockfish", "Other cephal."= "Other cephalopod", "Shortspine thorny."= "Shortspine thornyhead", "Widow rock."= "Widow rockfish")) + 
  xlim(0.75, 1.25) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + 
xlab("Relative biomass") + ylab("Species with low diet proportion") + 
labs(col = "End biomass", title= "B") + standard_theme 
#+ ggsave(width = 6, height = 5, "~/Documents/OTZ.manuscript/Images/dietunder.25.jpeg")
change_2_2_plot

#4: No dependence on mesopelagics
commercial_predators_df <- as.data.frame(commercial_predators) %>% rename(species= commercial_predators)
noncommercial_predators_df <- as.data.frame(noncommerical_predators) %>% rename(species= noncommerical_predators)
combo <- rbind(commercial_predators_df, noncommercial_predators_df, by= "species") %>% mutate(Dependence= 1)
no_dependence <- change_2_total %>% left_join(combo, by= "species")
no_dependence[is.na(no_dependence)] <- 0 #Functional groups with no dependence on mesopelagics have a 0
no_dependence <-no_dependence[!duplicated(no_dependence$species),] 
no_dependence <- no_dependence[-c(15,30),] #Remove mesopelagics and juvenile hake- dependence on mesopelagics but don't have commercial or non-commercial value so will be weird with filtering
no_dependence_final <- no_dependence %>% filter(Dependence==0)

change_2_3_df <- no_dependence_final
change_2_3 <- change_2_3_df %>% mutate(value = round(as.numeric(paste(value)), 2), "result" = cut(value, breaks = c(-Inf, 0.99, 1.001, Inf), labels = c("Decreasing", "Neither", "Increasing"), right = TRUE)) %>% arrange(value) %>% rename(biomass_prop= value) 
change_2_3_plot <- change_2_3 %>% ggplot() + geom_point(aes(x= biomass_prop, y=reorder(species, desc(species)))) + 
  scale_colour_viridis(discrete= TRUE, option= "D") + 
 scale_y_discrete(labels= c("Western Gull"= "Western gull", "Resident Orcas"= "Resident orcas", "Juv. Ele. Seal"= "Juv. elephant seal", "Greenstriped"= "Greenstriped rockfish", "Double corm."= "Double cormorant",    "Brandt's corm."= "Brandt's cormorant", "Arrowtooth"= "Arrowtooth flounder", "Canary rock."= "Canary rockfish", "Juv. rock."= "Juvenile rockfish", "Other cephal."= "Other cephalopod", "Shortspine thorny."= "Shortspine thornyhead", "Widow rock."= "Widow rockfish")) + 
  xlim(0.75, 1.25) + geom_vline(xintercept=1, linetype= "solid", color= "black", size= 0.75) + 
xlab("Relative biomass") + ylab("Species with low diet proportion") + 
labs(col = "End biomass", title= "B") + standard_theme 
#+ ggsave(width = 6, height = 5, "~/Documents/OTZ.manuscript/Images/dietunder.25.jpeg")
change_2_2_plot
```


